{{ define "main" }}
<div class="dashboard-container">
  <div class="container-fluid px-4">
    <!-- Trial Banner (shown via JS) -->
    <div id="trial-banner" class="alert alert-warning d-none mb-4" role="alert">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
          <strong id="trial-status-text">14 days left in your free trial</strong>
          <span class="d-block d-sm-inline ms-sm-2 text-muted small">Upgrade to continue tracking after your trial ends.</span>
        </div>
        <a href="/#pricing" class="btn btn-warning btn-sm">Upgrade Now</a>
      </div>
    </div>

    <!-- Expired Banner (shown via JS) -->
    <div id="expired-banner" class="alert alert-danger d-none mb-4" role="alert">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
          <strong>Your free trial has ended</strong>
          <span class="d-block d-sm-inline ms-sm-2">Upgrade to continue using Zero Trust Analytics.</span>
        </div>
        <a href="/#pricing" class="btn btn-danger btn-sm">Choose a Plan</a>
      </div>
    </div>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
      <div>
        <h1 class="h3 mb-1">Dashboard</h1>
        <p class="text-muted mb-0" id="current-site-domain" aria-live="polite">Select a site to view analytics</p>
      </div>
      <div class="d-flex gap-2 flex-wrap" role="toolbar" aria-label="Dashboard actions">
        <button class="btn btn-outline-secondary btn-sm" onclick="exportData('json')" aria-label="Export data as JSON">
          <i class="fas fa-download me-1" aria-hidden="true"></i>Export JSON
        </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="exportData('csv')" aria-label="Export data as CSV">
          <i class="fas fa-file-csv me-1" aria-hidden="true"></i>Export CSV
        </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="exportPDF()" aria-label="Export as PDF report">
          <i class="fas fa-file-pdf me-1" aria-hidden="true"></i>Export PDF
        </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="openShareModal()" aria-label="Share dashboard">
          <i class="fas fa-share-alt me-1" aria-hidden="true"></i>Share
        </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="openSessionsModal()" aria-label="Manage sessions">
          <i class="fas fa-shield-alt me-1" aria-hidden="true"></i>Sessions
        </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="openApiKeysModal()" aria-label="Manage API keys">
          <i class="fas fa-key me-1" aria-hidden="true"></i>API Keys
        </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="openActivityModal()" aria-label="View activity log">
          <i class="fas fa-history me-1" aria-hidden="true"></i>Activity
        </button>
        <!-- Planned feature: Webhook configuration -->
        <button class="btn btn-outline-secondary btn-sm d-none" onclick="openWebhooksModal()" aria-label="Manage webhooks">
          <i class="fas fa-bolt me-1" aria-hidden="true"></i>Webhooks
        </button>
        <!-- Planned feature: Alert configuration -->
        <button class="btn btn-outline-secondary btn-sm d-none" onclick="openAlertsModal()" aria-label="Configure alerts">
          <i class="fas fa-bell me-1" aria-hidden="true"></i>Alerts
        </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="openTeamsModal()" aria-label="Manage team">
          <i class="fas fa-users me-1" aria-hidden="true"></i>Team
        </button>
        <button class="btn btn-outline-secondary btn-sm" onclick="openGoalsModal()" aria-label="Track goals">
          <i class="fas fa-bullseye me-1" aria-hidden="true"></i>Goals
        </button>
        <!-- Planned feature: Funnel analysis -->
        <button class="btn btn-outline-secondary btn-sm d-none" onclick="openFunnelsModal()" aria-label="Funnel analysis">
          <i class="fas fa-filter me-1" aria-hidden="true"></i>Funnels
        </button>
        <!-- Planned feature: Heatmaps -->
        <button class="btn btn-outline-secondary btn-sm d-none" onclick="openHeatmapsModal()" aria-label="View heatmaps">
          <i class="fas fa-fire me-1" aria-hidden="true"></i>Heatmaps
        </button>
        <button class="btn btn-outline-secondary" onclick="openBillingPortal()" aria-label="Open billing portal">
          <i class="fas fa-credit-card me-1" aria-hidden="true"></i>Billing
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSiteModal" aria-label="Add a new site">
          <i class="fas fa-plus me-1" aria-hidden="true"></i>Add Site
        </button>
      </div>
    </div>

    <!-- Site Selector, Period & Date Range -->
    <div class="d-flex flex-wrap gap-3 mb-4 align-items-center" role="region" aria-label="Analytics filters">
      <div class="site-selector d-flex gap-2">
        <label for="site-selector" class="visually-hidden">Select a site</label>
        <select class="form-select" id="site-selector" onchange="loadStats()" aria-describedby="site-selector-help">
          <option value="">Select a site...</option>
        </select>
        <span id="site-selector-help" class="visually-hidden">Choose a website to view its analytics</span>
        <button class="btn btn-outline-secondary" id="site-settings-btn" onclick="openSiteSettings()" aria-label="Open site settings">
          <i class="fas fa-cog" aria-hidden="true"></i>
        </button>
      </div>
      <div class="period-selector btn-group" role="group" aria-label="Select time period">
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPeriod('24h')" aria-pressed="false">24h</button>
        <button type="button" class="btn btn-outline-secondary btn-sm active" onclick="setPeriod('7d')" aria-pressed="true">7d</button>
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPeriod('30d')" aria-pressed="false">30d</button>
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPeriod('90d')" aria-pressed="false">90d</button>
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPeriod('365d')" aria-pressed="false">1y</button>
      </div>
      <!-- Date Range Presets -->
      <div class="dropdown">
        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="datePresetDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-calendar-range me-1"></i>Quick Range
        </button>
        <ul class="dropdown-menu" aria-labelledby="datePresetDropdown">
          <li><h6 class="dropdown-header">Relative</h6></li>
          <li><a class="dropdown-item" href="#" onclick="setDatePreset('today'); return false;">Today</a></li>
          <li><a class="dropdown-item" href="#" onclick="setDatePreset('yesterday'); return false;">Yesterday</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><h6 class="dropdown-header">This Period</h6></li>
          <li><a class="dropdown-item" href="#" onclick="setDatePreset('this-week'); return false;">This Week</a></li>
          <li><a class="dropdown-item" href="#" onclick="setDatePreset('this-month'); return false;">This Month</a></li>
          <li><a class="dropdown-item" href="#" onclick="setDatePreset('this-quarter'); return false;">This Quarter</a></li>
          <li><a class="dropdown-item" href="#" onclick="setDatePreset('this-year'); return false;">This Year</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><h6 class="dropdown-header">Last Period</h6></li>
          <li><a class="dropdown-item" href="#" onclick="setDatePreset('last-week'); return false;">Last Week</a></li>
          <li><a class="dropdown-item" href="#" onclick="setDatePreset('last-month'); return false;">Last Month</a></li>
          <li><a class="dropdown-item" href="#" onclick="setDatePreset('last-quarter'); return false;">Last Quarter</a></li>
          <li><a class="dropdown-item" href="#" onclick="setDatePreset('last-year'); return false;">Last Year</a></li>
        </ul>
      </div>
      <fieldset class="d-flex gap-2 align-items-center">
        <legend class="visually-hidden">Custom date range</legend>
        <label for="start-date" class="visually-hidden">Start date</label>
        <input type="date" class="form-control form-control-sm" id="start-date" onchange="loadStatsCustomRange()">
        <span class="text-muted" aria-hidden="true">to</span>
        <label for="end-date" class="visually-hidden">End date</label>
        <input type="date" class="form-control form-control-sm" id="end-date" onchange="loadStatsCustomRange()">
      </fieldset>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="compare-toggle" onchange="toggleComparison()">
        <label class="form-check-label small" for="compare-toggle">Compare to previous period</label>
      </div>
    </div>

    <!-- Empty State (shown when no sites) -->
    <div class="empty-state" id="empty-state">
      <div class="empty-icon">
        <i class="fas fa-chart-line"></i>
      </div>
      <h3>No sites yet</h3>
      <p>Add your first website to start tracking anonymous analytics.</p>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSiteModal">
        <i class="fas fa-plus me-2"></i>Add Your First Site
      </button>
    </div>

    <!-- Loading Skeleton (shown while loading) -->
    <div id="loading-skeleton" style="display: none;">
      <div class="mb-4">
        <div class="skeleton" style="width: 200px; height: 40px; border-radius: 20px;"></div>
      </div>
      <div class="stats-grid mb-4">
        <div class="stat-card"><div class="skeleton skeleton-stat"></div><div class="skeleton skeleton-text" style="width: 60%;"></div></div>
        <div class="stat-card"><div class="skeleton skeleton-stat"></div><div class="skeleton skeleton-text" style="width: 60%;"></div></div>
        <div class="stat-card"><div class="skeleton skeleton-stat"></div><div class="skeleton skeleton-text" style="width: 60%;"></div></div>
        <div class="stat-card"><div class="skeleton skeleton-stat"></div><div class="skeleton skeleton-text" style="width: 60%;"></div></div>
      </div>
      <div class="row mb-4">
        <div class="col-lg-8 mb-4"><div class="card"><div class="card-header"><div class="skeleton skeleton-text" style="width: 40%;"></div></div><div class="card-body"><div class="skeleton skeleton-chart"></div></div></div></div>
        <div class="col-lg-4"><div class="card"><div class="card-header"><div class="skeleton skeleton-text" style="width: 50%;"></div></div><div class="card-body"><div class="skeleton skeleton-chart"></div></div></div></div>
      </div>
      <div class="row">
        <div class="col-lg-6 mb-4"><div class="data-table"><div class="p-3 bg-light"><div class="skeleton skeleton-text" style="width: 30%;"></div></div><div class="p-3"><div class="skeleton skeleton-row"></div><div class="skeleton skeleton-row"></div><div class="skeleton skeleton-row"></div></div></div></div>
        <div class="col-lg-6 mb-4"><div class="data-table"><div class="p-3 bg-light"><div class="skeleton skeleton-text" style="width: 30%;"></div></div><div class="p-3"><div class="skeleton skeleton-row"></div><div class="skeleton skeleton-row"></div><div class="skeleton skeleton-row"></div></div></div></div>
      </div>
    </div>

    <!-- Stats Content (hidden until site selected) -->
    <div id="stats-content" style="display: none;">

      <!-- Print Header (only visible when printing) -->
      <div class="print-header">
        <h1>Zero Trust Analytics Report</h1>
        <div class="print-meta">
          <span id="print-site-name"></span> &bull;
          <span id="print-date-range"></span> &bull;
          Generated <span id="print-timestamp"></span>
        </div>
      </div>

      <!-- Real-time Badge -->
      <div class="mb-4 d-flex flex-wrap gap-3 align-items-center">
        <div class="d-inline-flex align-items-center bg-success text-white px-3 py-2 rounded">
          <span class="pulse-dot me-2"></span>
          <span id="active-visitors">0</span> active visitor(s) right now
        </div>
        <div class="d-inline-flex align-items-center gap-2" id="realtime-sources" style="display: none !important;">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- Primary Stats Grid -->
      <div class="stats-grid mb-4">
        <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Number of distinct visitors (privacy-safe daily hash)">
          <div class="stat-value" id="unique-visitors">-</div>
          <div class="stat-label">Unique Visitors <i class="fas fa-info-circle text-muted small" aria-hidden="true"></i></div>
          <div class="stat-comparison" id="unique-visitors-compare"></div>
        </div>
        <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Total pages viewed across all visitors">
          <div class="stat-value" id="page-views">-</div>
          <div class="stat-label">Page Views <i class="fas fa-info-circle text-muted small" aria-hidden="true"></i></div>
          <div class="stat-comparison" id="page-views-compare"></div>
        </div>
        <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="bottom" title="A session ends after 30 minutes of inactivity">
          <div class="stat-value" id="sessions">-</div>
          <div class="stat-label">Sessions <i class="fas fa-info-circle text-muted small" aria-hidden="true"></i></div>
          <div class="stat-comparison" id="sessions-compare"></div>
        </div>
        <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Visitors who left after viewing only one page (lower is better)">
          <div class="stat-value" id="bounce-rate">-</div>
          <div class="stat-label">Bounce Rate <i class="fas fa-info-circle text-muted small" aria-hidden="true"></i></div>
          <div class="stat-comparison" id="bounce-rate-compare"></div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="row mb-4">
        <div class="col-lg-8 mb-4 mb-lg-0">
          <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Visitors & Pageviews</h5>
              <button class="btn btn-sm btn-outline-secondary" onclick="openAnnotationModal()" title="Add annotation">
                <i class="bi bi-pin-angle me-1"></i>Annotate
              </button>
            </div>
            <div class="card-body">
              <canvas id="visitors-chart" height="250"></canvas>
              <!-- Annotation markers populated by JS -->
              <div id="chart-annotations" class="mt-2 d-none">
                <small class="text-muted">Annotations:</small>
                <div id="annotation-list" class="d-flex flex-wrap gap-2 mt-1"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card h-100">
            <div class="card-header">
              <h5 class="mb-0">Traffic Sources</h5>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center">
              <canvas id="sources-chart" height="200"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Additional Charts Row -->
      <div class="row mb-4">
        <div class="col-lg-6 mb-4 mb-lg-0">
          <div class="card h-100">
            <div class="card-header">
              <h5 class="mb-0">Devices</h5>
            </div>
            <div class="card-body">
              <canvas id="devices-chart" height="200"></canvas>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card h-100">
            <div class="card-header">
              <h5 class="mb-0">Browsers</h5>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center">
              <canvas id="browsers-chart" height="200"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Secondary Stats Grid -->
      <div class="stats-grid stats-grid-secondary mb-4">
        <div class="stat-card stat-card-sm" data-bs-toggle="tooltip" title="Average time visitors spend on your site per session">
          <div class="stat-value" id="avg-session-duration">-</div>
          <div class="stat-label">Avg. Session Duration</div>
        </div>
        <div class="stat-card stat-card-sm" data-bs-toggle="tooltip" title="Average number of pages viewed per session">
          <div class="stat-value" id="pages-per-session">-</div>
          <div class="stat-label">Pages / Session</div>
        </div>
        <div class="stat-card stat-card-sm" data-bs-toggle="tooltip" title="How far visitors scroll down your pages on average">
          <div class="stat-value" id="avg-scroll-depth">-</div>
          <div class="stat-label">Avg. Scroll Depth</div>
        </div>
        <div class="stat-card stat-card-sm" data-bs-toggle="tooltip" title="First-time visitors vs returning visitors (based on daily hash)">
          <div class="stat-value" id="new-vs-returning">-</div>
          <div class="stat-label">New / Returning</div>
        </div>
      </div>

      <!-- Tab Navigation -->
      <ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="pages-tab" data-bs-toggle="tab" data-bs-target="#pages-panel" type="button" role="tab" aria-controls="pages-panel" aria-selected="true">
            <i class="fas fa-file-alt me-1 d-none d-sm-inline" aria-hidden="true"></i>Pages
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="sources-tab" data-bs-toggle="tab" data-bs-target="#sources-panel" type="button" role="tab" aria-controls="sources-panel" aria-selected="false">
            <i class="fas fa-link me-1 d-none d-sm-inline" aria-hidden="true"></i>Sources
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tech-tab" data-bs-toggle="tab" data-bs-target="#tech-panel" type="button" role="tab" aria-controls="tech-panel" aria-selected="false">
            <i class="fas fa-laptop me-1 d-none d-sm-inline" aria-hidden="true"></i>Tech
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="geo-tab" data-bs-toggle="tab" data-bs-target="#geo-panel" type="button" role="tab" aria-controls="geo-panel" aria-selected="false">
            <i class="fas fa-globe me-1 d-none d-sm-inline" aria-hidden="true"></i>Geo
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="events-tab" data-bs-toggle="tab" data-bs-target="#events-panel" type="button" role="tab" aria-controls="events-panel" aria-selected="false">
            <i class="fas fa-bolt me-1 d-none d-sm-inline" aria-hidden="true"></i>Events
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content" id="dashboardTabContent">
        <!-- Pages Tab -->
        <div class="tab-pane fade show active" id="pages-panel" role="tabpanel" aria-labelledby="pages-tab">
          <div class="row">
            <div class="col-lg-6 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light d-flex justify-content-between align-items-center">
                  Top Pages
                  <span class="badge bg-secondary" id="pages-count">0</span>
                </h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Page</th>
                      <th class="text-end">Views</th>
                      <th class="text-end">Avg Time</th>
                    </tr>
                  </thead>
                  <tbody id="top-pages-table">
                    <tr><td colspan="3" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-lg-6 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light">Landing Pages</h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Page</th>
                      <th class="text-end">Entrances</th>
                    </tr>
                  </thead>
                  <tbody id="landing-pages-table">
                    <tr><td colspan="2" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-6 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light">Exit Pages</h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Page</th>
                      <th class="text-end">Exits</th>
                    </tr>
                  </thead>
                  <tbody id="exit-pages-table">
                    <tr><td colspan="2" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Sources Tab -->
        <div class="tab-pane fade" id="sources-panel" role="tabpanel" aria-labelledby="sources-tab">
          <div class="row">
            <div class="col-lg-6 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light d-flex justify-content-between align-items-center">
                  Top Referrers
                  <span class="badge bg-secondary" id="referrers-count">0</span>
                </h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Source</th>
                      <th class="text-end">Visits</th>
                    </tr>
                  </thead>
                  <tbody id="top-referrers-table">
                    <tr><td colspan="2" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-lg-6 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light">Traffic Sources</h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Source Type</th>
                      <th class="text-end">Visits</th>
                    </tr>
                  </thead>
                  <tbody id="traffic-sources-table">
                    <tr><td colspan="2" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-6 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light">UTM Campaigns</h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Campaign</th>
                      <th class="text-end">Visits</th>
                    </tr>
                  </thead>
                  <tbody id="campaigns-table">
                    <tr><td colspan="2" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Tech Tab -->
        <div class="tab-pane fade" id="tech-panel" role="tabpanel" aria-labelledby="tech-tab">
          <div class="row">
            <div class="col-lg-4 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light">Devices</h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Device</th>
                      <th class="text-end">Visits</th>
                    </tr>
                  </thead>
                  <tbody id="devices-table">
                    <tr><td colspan="2" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-lg-4 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light">Browsers</h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Browser</th>
                      <th class="text-end">Visits</th>
                    </tr>
                  </thead>
                  <tbody id="browsers-table">
                    <tr><td colspan="2" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-lg-4 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light">Operating Systems</h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>OS</th>
                      <th class="text-end">Visits</th>
                    </tr>
                  </thead>
                  <tbody id="os-table">
                    <tr><td colspan="2" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Geo Tab -->
        <div class="tab-pane fade" id="geo-panel" role="tabpanel" aria-labelledby="geo-tab">
          <div class="row">
            <div class="col-lg-4 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light">Countries</h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Country</th>
                      <th class="text-end">Visitors</th>
                    </tr>
                  </thead>
                  <tbody id="countries-table">
                    <tr><td colspan="2" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-lg-4 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light">Languages</h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Language</th>
                      <th class="text-end">Visits</th>
                    </tr>
                  </thead>
                  <tbody id="languages-table">
                    <tr><td colspan="2" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Events Tab -->
        <div class="tab-pane fade" id="events-panel" role="tabpanel" aria-labelledby="events-tab">
          <div class="row">
            <div class="col-12 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light d-flex justify-content-between align-items-center">
                  <span>Custom Events <small class="text-muted">(<span id="total-events">0</span> total)</small></span>
                  <span class="badge bg-primary" id="events-value-total" style="display:none;">$0</span>
                </h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Event</th>
                      <th>Details</th>
                      <th class="text-end">Count</th>
                      <th class="text-end">Value</th>
                    </tr>
                  </thead>
                  <tbody id="events-table">
                    <tr><td colspan="4" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div><!-- End tab-content -->

      <!-- Embed Code -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Embed Code</h5>
          <button class="btn btn-sm btn-outline-primary" onclick="copyEmbedCode()">
            <i class="fas fa-copy me-1"></i>Copy
          </button>
        </div>
        <div class="card-body">
          <p class="text-muted small mb-2">Add this script to your website's <code>&lt;head&gt;</code> tag:</p>
          <div class="embed-code">
            <code id="embed-code">&lt;script src="https://ztas.io/js/analytics.js" data-site-id="YOUR_SITE_ID"&gt;&lt;/script&gt;</code>
          </div>
          <div class="mt-3">
            <p class="text-muted small mb-1">Optional attributes:</p>
            <ul class="small text-muted mb-0">
              <li><code>data-spa="true"</code> - Enable SPA route tracking</li>
              <li><code>data-debug="true"</code> - Enable console logging</li>
              <li><code>data-track-scroll="false"</code> - Disable scroll tracking</li>
              <li><code>data-track-outbound="false"</code> - Disable outbound link tracking</li>
              <li><code>data-track-forms="false"</code> - Disable form submission tracking</li>
            </ul>
          </div>
          <div class="mt-3">
            <p class="text-muted small mb-1">Custom event tracking:</p>
            <pre class="bg-light p-2 rounded small mb-0"><code>// Track simple events
ZTA.track('signup');
ZTA.track('button_click');

// Track events with properties
ZTA.track('purchase', { amount: 99 });
ZTA.track('download', { file: 'report.pdf' });</code></pre>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Annotation Modal -->
<div class="modal fade" id="annotationModal" tabindex="-1" aria-labelledby="annotationModalTitle">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="annotationModalTitle">
          <i class="bi bi-pin-angle me-2"></i>Chart Annotations
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Mark important events on your analytics chart.</p>

        <!-- No Site Selected Warning -->
        <div id="annotation-no-site" class="alert alert-info d-none">
          <i class="bi bi-info-circle me-2"></i>Please select a site first.
        </div>

        <!-- Create New Annotation -->
        <div class="card mb-4" id="annotation-create-section">
          <div class="card-header">
            <h6 class="mb-0">Add Annotation</h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Date</label>
                <input type="date" class="form-control" id="new-annotation-date">
              </div>
              <div class="col-md-6">
                <label class="form-label">Icon</label>
                <select class="form-select" id="new-annotation-icon">
                  <option value="star">‚≠ê Star</option>
                  <option value="rocket">üöÄ Launch</option>
                  <option value="megaphone">üì£ Campaign</option>
                  <option value="flag">üö© Milestone</option>
                  <option value="bug">üêõ Bug Fix</option>
                  <option value="gift">üéÅ Release</option>
                </select>
              </div>
            </div>
            <div class="mt-3">
              <label class="form-label">Title</label>
              <input type="text" class="form-control" id="new-annotation-title" placeholder="e.g., Product Launch">
            </div>
            <div class="mt-3">
              <label class="form-label">Description <span class="text-muted">(optional)</span></label>
              <textarea class="form-control" id="new-annotation-description" rows="2" placeholder="Brief description..."></textarea>
            </div>
            <div class="mt-3">
              <label class="form-label">Color</label>
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-primary btn-sm annotation-color active" data-color="#0d6efd" style="width: 32px; height: 32px;"></button>
                <button type="button" class="btn btn-success btn-sm annotation-color" data-color="#198754" style="width: 32px; height: 32px;"></button>
                <button type="button" class="btn btn-warning btn-sm annotation-color" data-color="#ffc107" style="width: 32px; height: 32px;"></button>
                <button type="button" class="btn btn-danger btn-sm annotation-color" data-color="#dc3545" style="width: 32px; height: 32px;"></button>
                <button type="button" class="btn btn-info btn-sm annotation-color" data-color="#0dcaf0" style="width: 32px; height: 32px;"></button>
                <button type="button" class="btn btn-dark btn-sm annotation-color" data-color="#212529" style="width: 32px; height: 32px;"></button>
              </div>
            </div>
            <button class="btn btn-primary mt-3" onclick="createAnnotation()">
              <i class="bi bi-plus-lg me-1"></i>Add Annotation
            </button>
          </div>
        </div>

        <!-- Existing Annotations -->
        <h6 class="text-muted mb-3">Your Annotations</h6>
        <div id="annotations-loading" class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <span class="ms-2">Loading annotations...</span>
        </div>

        <div id="annotations-list" class="d-none">
          <!-- Annotations populated by JS -->
        </div>

        <div id="annotations-empty" class="d-none text-center py-4 text-muted">
          <i class="bi bi-pin-angle" style="font-size: 2rem;"></i>
          <p class="mt-2">No annotations yet</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Teams Modal -->
<div class="modal fade" id="teamsModal" tabindex="-1" aria-labelledby="teamsModalTitle">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="teamsModalTitle">
          <i class="bi bi-people me-2"></i>Team Management
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Collaborate with your team by sharing access to your analytics dashboards.</p>

        <!-- No Team Yet -->
        <div id="teams-no-team" class="text-center py-4 d-none">
          <i class="bi bi-people" style="font-size: 3rem; color: #6c757d;"></i>
          <h5 class="mt-3">You're not part of any team yet</h5>
          <p class="text-muted">Create a team to collaborate with others.</p>
          <button class="btn btn-primary" onclick="showCreateTeamForm()">
            <i class="bi bi-plus-lg me-1"></i>Create Team
          </button>
        </div>

        <!-- Create Team Form (hidden by default) -->
        <div id="team-create-form" class="card mb-4 d-none">
          <div class="card-header">
            <h6 class="mb-0">Create New Team</h6>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Team Name</label>
              <input type="text" class="form-control" id="new-team-name" placeholder="e.g., My Company">
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-primary" onclick="createTeam()">
                <i class="bi bi-plus-lg me-1"></i>Create Team
              </button>
              <button class="btn btn-outline-secondary" onclick="hideCreateTeamForm()">Cancel</button>
            </div>
          </div>
        </div>

        <!-- Team Selector (when multiple teams) -->
        <div id="team-selector-section" class="mb-4 d-none">
          <label class="form-label">Select Team</label>
          <select class="form-select" id="team-selector" onchange="loadTeamDetails()">
            <option value="">Select a team...</option>
          </select>
        </div>

        <!-- Team Details -->
        <div id="team-details" class="d-none">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0" id="current-team-name">Team Name</h5>
            <span class="badge bg-primary" id="current-user-role">Owner</span>
          </div>

          <!-- Invite Member Section -->
          <div class="card mb-4" id="team-invite-section">
            <div class="card-header">
              <h6 class="mb-0"><i class="bi bi-person-plus me-2"></i>Invite Team Member</h6>
            </div>
            <div class="card-body">
              <div class="row g-2">
                <div class="col-md-5">
                  <input type="email" class="form-control" id="invite-email" placeholder="colleague@company.com">
                </div>
                <div class="col-md-4">
                  <select class="form-select" id="invite-role">
                    <option value="viewer">Viewer (read-only)</option>
                    <option value="editor">Editor (can edit)</option>
                    <option value="admin">Admin (full access)</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <button class="btn btn-primary w-100" onclick="inviteTeamMember()">
                    <i class="bi bi-send me-1"></i>Invite
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Invite Link Display -->
          <div class="alert alert-success d-none" id="invite-success">
            <h6 class="alert-heading"><i class="bi bi-check-circle me-2"></i>Invite Sent!</h6>
            <p class="mb-2">Share this link with <strong id="invite-email-display"></strong>:</p>
            <div class="input-group mb-2">
              <input type="text" class="form-control font-monospace small" id="invite-link" readonly>
              <button class="btn btn-outline-secondary" onclick="copyInviteLink()">
                <i class="bi bi-clipboard"></i>
              </button>
            </div>
            <small class="text-muted">This link expires in 7 days.</small>
          </div>

          <!-- Pending Invites -->
          <div id="team-invites-section" class="mb-4 d-none">
            <h6 class="text-muted mb-3"><i class="bi bi-clock me-2"></i>Pending Invites</h6>
            <div id="team-invites-list"></div>
          </div>

          <!-- Team Members -->
          <h6 class="text-muted mb-3"><i class="bi bi-people me-2"></i>Team Members</h6>
          <div id="teams-loading" class="text-center py-4">
            <div class="spinner-border spinner-border-sm text-primary"></div>
            <span class="ms-2">Loading team...</span>
          </div>

          <div id="team-members-list" class="d-none">
            <!-- Members populated by JS -->
          </div>

          <!-- Add Sites to Team -->
          <div class="card mt-4" id="team-sites-section">
            <div class="card-header">
              <h6 class="mb-0"><i class="bi bi-globe me-2"></i>Team Sites</h6>
            </div>
            <div class="card-body">
              <p class="text-muted small mb-3">Sites shared with the team will be accessible to all members based on their role.</p>
              <div class="row g-2 mb-3">
                <div class="col-md-8">
                  <select class="form-select" id="site-to-add">
                    <option value="">Select a site to share...</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <button class="btn btn-outline-primary w-100" onclick="addSiteToTeam()">
                    <i class="bi bi-plus-lg me-1"></i>Add to Team
                  </button>
                </div>
              </div>
              <div id="team-sites-list" class="small">
                <!-- Sites populated by JS -->
              </div>
            </div>
          </div>

          <!-- Team Actions -->
          <div class="mt-4 pt-3 border-top" id="team-actions">
            <button class="btn btn-outline-danger btn-sm" onclick="leaveCurrentTeam()">
              <i class="bi bi-box-arrow-left me-1"></i>Leave Team
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Goals Modal -->
<div class="modal fade" id="goalsModal" tabindex="-1" aria-labelledby="goalsModalTitle">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="goalsModalTitle">
          <i class="bi bi-bullseye me-2"></i>Goal Tracking
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Set targets for your key metrics and track progress over time.</p>

        <!-- No Site Selected Warning -->
        <div id="goals-no-site" class="alert alert-info d-none">
          <i class="bi bi-info-circle me-2"></i>Please select a site first to manage goals.
        </div>

        <!-- Create New Goal -->
        <div class="card mb-4" id="goal-create-section">
          <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Create New Goal</h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Goal Name</label>
                <input type="text" class="form-control" id="new-goal-name" placeholder="e.g., 10K Monthly Visitors">
              </div>
              <div class="col-md-6">
                <label class="form-label">Metric</label>
                <select class="form-select" id="new-goal-metric">
                  <option value="pageviews">Pageviews</option>
                  <option value="visitors">Unique Visitors</option>
                  <option value="sessions">Sessions</option>
                  <option value="events">Custom Events</option>
                  <option value="bounce_rate">Bounce Rate (%)</option>
                  <option value="session_duration">Avg Session Duration (s)</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Target</label>
                <input type="number" class="form-control" id="new-goal-target" placeholder="10000" min="1">
              </div>
              <div class="col-md-4">
                <label class="form-label">Period</label>
                <select class="form-select" id="new-goal-period">
                  <option value="daily">Daily</option>
                  <option value="weekly">Weekly</option>
                  <option value="monthly" selected>Monthly</option>
                  <option value="quarterly">Quarterly</option>
                  <option value="yearly">Yearly</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Comparison</label>
                <select class="form-select" id="new-goal-comparison">
                  <option value="gte">At Least (>=)</option>
                  <option value="lte">At Most (<=)</option>
                </select>
              </div>
              <div class="col-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="new-goal-notify" checked>
                  <label class="form-check-label" for="new-goal-notify">Notify me when goal is reached</label>
                </div>
              </div>
            </div>
            <button class="btn btn-primary mt-3" onclick="createGoal()">
              <i class="bi bi-plus-lg me-1"></i>Create Goal
            </button>
          </div>
        </div>

        <!-- Active Goals -->
        <h6 class="text-muted mb-3"><i class="bi bi-bar-chart me-2"></i>Your Goals</h6>
        <div id="goals-loading" class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <span class="ms-2">Loading goals...</span>
        </div>

        <div id="goals-list" class="d-none">
          <!-- Goals populated by JS -->
        </div>

        <div id="goals-empty" class="d-none text-center py-4 text-muted">
          <i class="bi bi-bullseye" style="font-size: 2rem;"></i>
          <p class="mt-2">No goals set yet</p>
          <p class="small">Create your first goal above to start tracking progress</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Funnels Modal -->
<div class="modal fade" id="funnelsModal" tabindex="-1" aria-labelledby="funnelsModalTitle">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="funnelsModalTitle">
          <i class="bi bi-funnel me-2"></i>Conversion Funnels
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Track user journeys through your site and identify where visitors drop off.</p>

        <!-- No Site Selected Warning -->
        <div id="funnels-no-site" class="alert alert-info d-none">
          <i class="bi bi-info-circle me-2"></i>Please select a site first to manage funnels.
        </div>

        <!-- Create New Funnel -->
        <div class="card mb-4" id="funnel-create-section">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Create New Funnel</h6>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#funnelCreateForm">
              <i class="bi bi-chevron-down"></i>
            </button>
          </div>
          <div class="collapse" id="funnelCreateForm">
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label">Funnel Name</label>
                <input type="text" class="form-control" id="new-funnel-name" placeholder="e.g., Checkout Flow">
              </div>

              <label class="form-label">Funnel Steps <span class="text-muted small">(minimum 2)</span></label>
              <div id="funnel-steps-container">
                <div class="funnel-step mb-2">
                  <div class="row g-2">
                    <div class="col-md-3">
                      <input type="text" class="form-control form-control-sm" placeholder="Step name" data-field="name">
                    </div>
                    <div class="col-md-2">
                      <select class="form-select form-select-sm" data-field="type">
                        <option value="page">Page</option>
                        <option value="event">Event</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <select class="form-select form-select-sm" data-field="operator">
                        <option value="equals">Equals</option>
                        <option value="contains">Contains</option>
                        <option value="starts_with">Starts with</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <input type="text" class="form-control form-control-sm" placeholder="e.g., /home or signup:click" data-field="value">
                    </div>
                    <div class="col-md-1">
                      <button class="btn btn-sm btn-outline-danger" onclick="removeFunnelStep(this)" disabled>
                        <i class="bi bi-x"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="funnel-step mb-2">
                  <div class="row g-2">
                    <div class="col-md-3">
                      <input type="text" class="form-control form-control-sm" placeholder="Step name" data-field="name">
                    </div>
                    <div class="col-md-2">
                      <select class="form-select form-select-sm" data-field="type">
                        <option value="page">Page</option>
                        <option value="event">Event</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <select class="form-select form-select-sm" data-field="operator">
                        <option value="equals">Equals</option>
                        <option value="contains">Contains</option>
                        <option value="starts_with">Starts with</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <input type="text" class="form-control form-control-sm" placeholder="e.g., /checkout" data-field="value">
                    </div>
                    <div class="col-md-1">
                      <button class="btn btn-sm btn-outline-danger" onclick="removeFunnelStep(this)" disabled>
                        <i class="bi bi-x"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="d-flex gap-2 mb-3">
                <button class="btn btn-outline-secondary btn-sm" onclick="addFunnelStep()">
                  <i class="bi bi-plus me-1"></i>Add Step
                </button>
              </div>

              <button class="btn btn-primary" onclick="createFunnel()">
                <i class="bi bi-plus-lg me-1"></i>Create Funnel
              </button>
            </div>
          </div>
        </div>

        <!-- Existing Funnels -->
        <h6 class="text-muted mb-3"><i class="bi bi-bar-chart me-2"></i>Your Funnels</h6>
        <div id="funnels-loading" class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <span class="ms-2">Loading funnels...</span>
        </div>

        <div id="funnels-list" class="d-none">
          <!-- Funnels populated by JS -->
        </div>

        <div id="funnels-empty" class="d-none text-center py-4 text-muted">
          <i class="bi bi-funnel" style="font-size: 2rem;"></i>
          <p class="mt-2">No funnels created yet</p>
          <p class="small">Create your first funnel to start tracking conversions</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Heatmaps Modal -->
<div class="modal fade" id="heatmapsModal" tabindex="-1" aria-labelledby="heatmapsModalTitle">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="heatmapsModalTitle">
          <i class="bi bi-fire me-2"></i>Heatmaps
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Visualize where users click and how far they scroll on your pages.</p>

        <!-- No Site Selected Warning -->
        <div id="heatmaps-no-site" class="alert alert-info d-none">
          <i class="bi bi-info-circle me-2"></i>Please select a site first to view heatmaps.
        </div>

        <!-- Heatmap Controls -->
        <div class="card mb-4" id="heatmap-controls">
          <div class="card-body">
            <div class="row g-3 align-items-end">
              <div class="col-md-5">
                <label class="form-label">Select Page</label>
                <select class="form-select" id="heatmap-page-select" onchange="loadHeatmapData()">
                  <option value="">Loading pages...</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">View Type</label>
                <select class="form-select" id="heatmap-view-type" onchange="loadHeatmapData()">
                  <option value="clicks">Click Heatmap</option>
                  <option value="scroll">Scroll Depth</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Date Range</label>
                <div class="input-group">
                  <input type="date" class="form-control form-control-sm" id="heatmap-start-date">
                  <span class="input-group-text">to</span>
                  <input type="date" class="form-control form-control-sm" id="heatmap-end-date">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Loading State -->
        <div id="heatmap-loading" class="text-center py-5 d-none">
          <div class="spinner-border text-primary"></div>
          <p class="mt-2 text-muted">Loading heatmap data...</p>
        </div>

        <!-- Click Heatmap View -->
        <div id="heatmap-clicks-view" class="d-none">
          <div class="row">
            <div class="col-md-8">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <span><i class="bi bi-cursor me-2"></i>Click Density</span>
                  <span class="badge bg-primary" id="heatmap-total-clicks">0 clicks</span>
                </div>
                <div class="card-body p-0">
                  <div id="heatmap-canvas-container" style="position: relative; background: #f8f9fa; min-height: 400px;">
                    <canvas id="heatmap-canvas" width="800" height="600" style="width: 100%; max-width: 800px; display: block; margin: 0 auto;"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card">
                <div class="card-header"><i class="bi bi-display me-2"></i>Viewport Distribution</div>
                <div class="card-body">
                  <div id="heatmap-viewport-stats">
                    <p class="text-muted small">Shows which screen sizes your visitors use</p>
                    <div id="heatmap-viewports-list">
                      <!-- Populated by JS -->
                    </div>
                  </div>
                </div>
              </div>
              <div class="card mt-3">
                <div class="card-header"><i class="bi bi-palette me-2"></i>Legend</div>
                <div class="card-body">
                  <div class="d-flex align-items-center mb-2">
                    <div style="width: 24px; height: 24px; background: linear-gradient(to right, blue, cyan, lime, yellow, red); border-radius: 4px;"></div>
                    <span class="ms-2 small">Low to High Click Density</span>
                  </div>
                  <p class="text-muted small mb-0">Warmer colors indicate more clicks in that area.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Scroll Depth View -->
        <div id="heatmap-scroll-view" class="d-none">
          <div class="row">
            <div class="col-md-8">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <span><i class="bi bi-arrow-down-circle me-2"></i>Scroll Reach</span>
                  <span class="badge bg-primary" id="heatmap-total-sessions">0 sessions</span>
                </div>
                <div class="card-body">
                  <div id="scroll-depth-chart" style="min-height: 300px;">
                    <!-- Scroll depth bars populated by JS -->
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card">
                <div class="card-header"><i class="bi bi-bar-chart me-2"></i>Key Metrics</div>
                <div class="card-body">
                  <div class="mb-3">
                    <div class="text-muted small">Average Max Scroll</div>
                    <div class="h4 mb-0" id="heatmap-avg-scroll">--%</div>
                  </div>
                  <div class="mb-3">
                    <div class="text-muted small">Reached 25%</div>
                    <div class="h5 mb-0" id="heatmap-reach-25">--%</div>
                  </div>
                  <div class="mb-3">
                    <div class="text-muted small">Reached 50%</div>
                    <div class="h5 mb-0" id="heatmap-reach-50">--%</div>
                  </div>
                  <div class="mb-3">
                    <div class="text-muted small">Reached 75%</div>
                    <div class="h5 mb-0" id="heatmap-reach-75">--%</div>
                  </div>
                  <div>
                    <div class="text-muted small">Reached 100%</div>
                    <div class="h5 mb-0" id="heatmap-reach-100">--%</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- No Data State -->
        <div id="heatmap-no-data" class="d-none text-center py-5 text-muted">
          <i class="bi bi-fire" style="font-size: 3rem;"></i>
          <h5 class="mt-3">No heatmap data yet</h5>
          <p>Heatmap data will appear here once visitors interact with your site.</p>
          <p class="small">Make sure the tracking script is installed and includes heatmap tracking.</p>
        </div>

        <!-- No Pages State -->
        <div id="heatmap-no-pages" class="d-none text-center py-5 text-muted">
          <i class="bi bi-file-earmark" style="font-size: 3rem;"></i>
          <h5 class="mt-3">No pages with heatmap data</h5>
          <p>No pages have recorded heatmap data in the selected date range.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Alerts Modal -->
<div class="modal fade" id="alertsModal" tabindex="-1" aria-labelledby="alertsModalTitle">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="alertsModalTitle">
          <i class="bi bi-bell me-2"></i>Traffic Alerts
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Get notified when your traffic spikes or drops significantly.</p>

        <!-- No Site Selected Warning -->
        <div id="alerts-no-site" class="alert alert-info d-none">
          <i class="bi bi-info-circle me-2"></i>Please select a site first to configure alerts.
        </div>

        <!-- Traffic Baseline -->
        <div id="alerts-baseline" class="alert alert-light mb-4 d-none">
          <h6 class="alert-heading"><i class="bi bi-graph-up me-2"></i>Your Traffic Baseline</h6>
          <div class="row text-center mt-3">
            <div class="col-4">
              <div class="h4 mb-0" id="baseline-hourly">-</div>
              <small class="text-muted">Avg. Hourly</small>
            </div>
            <div class="col-4">
              <div class="h4 mb-0" id="baseline-daily">-</div>
              <small class="text-muted">Avg. Daily</small>
            </div>
            <div class="col-4">
              <div class="h4 mb-0" id="baseline-days">-</div>
              <small class="text-muted">Days of Data</small>
            </div>
          </div>
        </div>

        <!-- Create New Alert -->
        <div class="card mb-4" id="alert-create-section">
          <div class="card-header">
            <h6 class="mb-0">Create Traffic Alert</h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Alert Name</label>
                <input type="text" class="form-control" id="new-alert-name" placeholder="e.g., Traffic Spike Alert">
              </div>
              <div class="col-md-6">
                <label class="form-label">Alert Type</label>
                <select class="form-select" id="new-alert-type">
                  <option value="traffic_spike">Traffic Spike (above baseline)</option>
                  <option value="low_traffic">Low Traffic (below baseline)</option>
                </select>
              </div>
            </div>
            <div class="row g-3 mt-2">
              <div class="col-md-4">
                <label class="form-label">Threshold</label>
                <div class="input-group">
                  <input type="number" class="form-control" id="new-alert-threshold" value="200" min="50" max="1000">
                  <span class="input-group-text">%</span>
                </div>
                <small class="text-muted">e.g., 200% = 2x normal traffic</small>
              </div>
              <div class="col-md-4">
                <label class="form-label">Time Window</label>
                <div class="input-group">
                  <input type="number" class="form-control" id="new-alert-window" value="60" min="15" max="1440">
                  <span class="input-group-text">min</span>
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Cooldown</label>
                <div class="input-group">
                  <input type="number" class="form-control" id="new-alert-cooldown" value="60" min="15" max="1440">
                  <span class="input-group-text">min</span>
                </div>
              </div>
            </div>
            <div class="mt-3">
              <label class="form-label">Notifications</label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="new-alert-email" checked>
                <label class="form-check-label" for="new-alert-email">Email notification</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="new-alert-webhook">
                <label class="form-check-label" for="new-alert-webhook">Send to configured webhooks</label>
              </div>
            </div>
            <button class="btn btn-primary mt-3" onclick="createAlert()">
              <i class="bi bi-plus-lg me-1"></i>Create Alert
            </button>
          </div>
        </div>

        <!-- Existing Alerts -->
        <h6 class="text-muted mb-3">Your Alerts</h6>
        <div id="alerts-loading" class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <span class="ms-2">Loading alerts...</span>
        </div>

        <div id="alerts-list" class="d-none">
          <!-- Alerts populated by JS -->
        </div>

        <div id="alerts-empty" class="d-none text-center py-4 text-muted">
          <i class="bi bi-bell" style="font-size: 2rem;"></i>
          <p class="mt-2">No alerts configured</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Webhooks Modal -->
<div class="modal fade" id="webhooksModal" tabindex="-1" aria-labelledby="webhooksModalTitle">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="webhooksModalTitle">
          <i class="bi bi-lightning me-2"></i>Webhooks
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Receive real-time notifications when events occur on your site.</p>

        <!-- No Site Selected Warning -->
        <div id="webhooks-no-site" class="alert alert-info d-none">
          <i class="bi bi-info-circle me-2"></i>Please select a site first to manage webhooks.
        </div>

        <!-- Create New Webhook -->
        <div class="card mb-4" id="webhook-create-section">
          <div class="card-header">
            <h6 class="mb-0">Create New Webhook</h6>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Webhook Name</label>
              <input type="text" class="form-control" id="new-webhook-name" placeholder="e.g., Slack Notifications">
            </div>
            <div class="mb-3">
              <label class="form-label">Endpoint URL <span class="text-muted">(HTTPS required)</span></label>
              <input type="url" class="form-control" id="new-webhook-url" placeholder="https://your-server.com/webhook">
            </div>
            <div class="mb-3">
              <label class="form-label">Events to receive</label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="event" id="webhook-event-event" checked>
                <label class="form-check-label" for="webhook-event-event">Custom Events</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="pageview" id="webhook-event-pageview">
                <label class="form-check-label" for="webhook-event-pageview">Pageviews <span class="text-muted small">(high volume)</span></label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="daily_summary" id="webhook-event-daily">
                <label class="form-check-label" for="webhook-event-daily">Daily Summary</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="traffic_spike" id="webhook-event-spike">
                <label class="form-check-label" for="webhook-event-spike">Traffic Spikes</label>
              </div>
            </div>
            <button class="btn btn-primary" onclick="createWebhook()">
              <i class="bi bi-plus-lg me-1"></i>Create Webhook
            </button>
          </div>
        </div>

        <!-- New Webhook Secret Display -->
        <div class="alert alert-success d-none" id="new-webhook-display">
          <h6 class="alert-heading"><i class="bi bi-check-circle me-2"></i>Webhook Created!</h6>
          <p class="mb-2">Copy the signing secret now. You won't be able to see it again.</p>
          <div class="input-group mb-2">
            <input type="text" class="form-control font-monospace" id="new-webhook-secret" readonly>
            <button class="btn btn-outline-secondary" onclick="copyWebhookSecret()">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>
          <small class="text-muted">Use this secret to verify webhook signatures.</small>
        </div>

        <!-- Existing Webhooks -->
        <h6 class="text-muted mb-3">Your Webhooks</h6>
        <div id="webhooks-loading" class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <span class="ms-2">Loading webhooks...</span>
        </div>

        <div id="webhooks-list" class="d-none">
          <!-- Webhooks populated by JS -->
        </div>

        <div id="webhooks-empty" class="d-none text-center py-4 text-muted">
          <i class="bi bi-lightning" style="font-size: 2rem;"></i>
          <p class="mt-2">No webhooks configured</p>
        </div>

        <!-- Webhook Documentation -->
        <div class="card mt-4">
          <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-book me-2"></i>Webhook Payload</h6>
          </div>
          <div class="card-body">
            <p class="small text-muted mb-2">Webhooks are sent as POST requests with JSON payloads:</p>
            <pre class="bg-light p-2 rounded small mb-2"><code>{
  "event": "event",
  "timestamp": "2024-01-15T10:30:00Z",
  "site_id": "site_xxx",
  "data": { ... }
}</code></pre>
            <p class="small text-muted mb-0">
              Verify the <code>X-ZTA-Signature</code> header using HMAC-SHA256 with your signing secret.
            </p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Activity Log Modal -->
<div class="modal fade" id="activityModal" tabindex="-1" aria-labelledby="activityModalTitle">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="activityModalTitle">
          <i class="bi bi-clock-history me-2"></i>Activity Log
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Recent account activity and security events.</p>

        <div id="activity-loading" class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <span class="ms-2">Loading activity...</span>
        </div>

        <div id="activity-list" class="d-none">
          <!-- Activities populated by JS -->
        </div>

        <div id="activity-empty" class="d-none text-center py-4 text-muted">
          <i class="bi bi-clock-history" style="font-size: 2rem;"></i>
          <p class="mt-2">No activity yet</p>
        </div>

        <div id="activity-load-more" class="text-center mt-3 d-none">
          <button class="btn btn-outline-secondary btn-sm" onclick="loadMoreActivity()">
            Load More
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- API Keys Modal -->
<div class="modal fade" id="apiKeysModal" tabindex="-1" aria-labelledby="apiKeysModalTitle">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="apiKeysModalTitle">
          <i class="bi bi-key me-2"></i>API Keys
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">API keys allow programmatic access to your analytics data.</p>

        <!-- Create New Key -->
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="mb-0">Create New API Key</h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Key Name</label>
                <input type="text" class="form-control" id="new-key-name" placeholder="e.g., Production App">
              </div>
              <div class="col-md-6">
                <label class="form-label">Permissions</label>
                <select class="form-select" id="new-key-permissions">
                  <option value="read">Read Only</option>
                  <option value="read,write">Read & Write</option>
                </select>
              </div>
            </div>
            <button class="btn btn-primary mt-3" onclick="createApiKey()">
              <i class="bi bi-plus-lg me-1"></i>Generate API Key
            </button>
          </div>
        </div>

        <!-- New Key Display (hidden by default) -->
        <div class="alert alert-success d-none" id="new-key-display">
          <h6 class="alert-heading"><i class="bi bi-check-circle me-2"></i>API Key Created!</h6>
          <p class="mb-2">Copy this key now. You won't be able to see it again.</p>
          <div class="input-group mb-2">
            <input type="text" class="form-control font-monospace" id="new-key-value" readonly>
            <button class="btn btn-outline-secondary" onclick="copyNewApiKey()">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>
          <small class="text-muted">Make sure to store this key securely.</small>
        </div>

        <!-- Existing Keys -->
        <h6 class="text-muted mb-3">Your API Keys</h6>
        <div id="api-keys-loading" class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <span class="ms-2">Loading keys...</span>
        </div>

        <div id="api-keys-list" class="d-none">
          <!-- Keys populated by JS -->
        </div>

        <div id="api-keys-empty" class="d-none text-center py-4 text-muted">
          <i class="bi bi-key" style="font-size: 2rem;"></i>
          <p class="mt-2">No API keys yet</p>
        </div>

        <!-- API Documentation -->
        <div class="card mt-4">
          <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-book me-2"></i>Quick Start</h6>
          </div>
          <div class="card-body">
            <p class="small text-muted mb-2">Use your API key in the Authorization header:</p>
            <pre class="bg-light p-2 rounded small mb-2"><code>curl -H "Authorization: Bearer YOUR_API_KEY" \
  https://ztas.io/api/stats?siteId=YOUR_SITE_ID&period=7d</code></pre>
            <p class="small text-muted mb-0">
              <a href="/docs/api/" target="_blank">View full API documentation</a>
            </p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Sessions Modal -->
<div class="modal fade" id="sessionsModal" tabindex="-1" aria-labelledby="sessionsModalTitle">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="sessionsModalTitle">
          <i class="bi bi-shield-check me-2"></i>Active Sessions
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Manage devices and browsers where you're currently logged in.</p>

        <div id="sessions-loading" class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <span class="ms-2">Loading sessions...</span>
        </div>

        <div id="sessions-list" class="d-none">
          <!-- Sessions populated by JS -->
        </div>

        <div id="sessions-empty" class="d-none text-center py-4 text-muted">
          <i class="bi bi-shield-x" style="font-size: 2rem;"></i>
          <p class="mt-2">No active sessions found</p>
        </div>
      </div>
      <div class="modal-footer justify-content-between">
        <button type="button" class="btn btn-outline-danger" onclick="revokeAllSessions()">
          <i class="bi bi-box-arrow-right me-1"></i>Sign Out All Other Devices
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Site Modal -->
<!-- Share Dashboard Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalTitle">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="shareModalTitle">
          <i class="bi bi-share me-2"></i>Share Dashboard
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Create New Share -->
        <div id="share-create-section">
          <p class="text-muted mb-3">Create a public link to share your analytics dashboard with others.</p>

          <div class="mb-3">
            <label class="form-label">Link Expiration</label>
            <select class="form-select" id="share-expiry">
              <option value="">Never expires</option>
              <option value="1d">1 day</option>
              <option value="7d">7 days</option>
              <option value="30d">30 days</option>
              <option value="90d">90 days</option>
            </select>
          </div>

          <button class="btn btn-primary w-100" onclick="createShareLink()">
            <i class="bi bi-link-45deg me-1"></i>Generate Share Link
          </button>
        </div>

        <!-- Share Link Result -->
        <div id="share-result-section" class="d-none">
          <div class="alert alert-success">
            <i class="bi bi-check-circle me-2"></i>Share link created!
          </div>

          <div class="input-group mb-3">
            <input type="text" class="form-control" id="share-url" readonly>
            <button class="btn btn-outline-primary" onclick="copyShareLink()">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>

          <button class="btn btn-outline-secondary w-100" onclick="showCreateShare()">
            <i class="bi bi-plus me-1"></i>Create Another Link
          </button>
        </div>

        <!-- Existing Shares -->
        <div id="existing-shares-section" class="mt-4 pt-3 border-top">
          <h6 class="text-muted mb-3">Active Share Links</h6>
          <div id="shares-list">
            <p class="text-muted small">Loading...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="addSiteModal" tabindex="-1" aria-labelledby="addSiteModalTitle" aria-describedby="addSiteModalDesc">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="addSiteModalTitle">Add New Site</h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close dialog"></button>
      </div>
      <div class="modal-body">
        <p id="addSiteModalDesc" class="visually-hidden">Add a new website to track with Zero Trust Analytics</p>
        <form id="add-site-form" onsubmit="handleAddSite(event)" novalidate>
          <div class="mb-3">
            <label for="site-domain" class="form-label">Website Domain</label>
            <input
              type="text"
              class="form-control"
              id="site-domain"
              placeholder="example.com"
              required
              aria-required="true"
              aria-describedby="site-domain-hint"
            >
            <div id="site-domain-hint" class="form-text">Enter your domain without https://</div>
          </div>
          <div class="alert alert-danger d-none" id="add-site-error" role="alert" aria-live="polite"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="add-site-form" class="btn btn-primary">Add Site</button>
      </div>
    </div>
  </div>
</div>

<!-- Site Settings Modal -->
<div class="modal fade" id="siteSettingsModal" tabindex="-1" aria-labelledby="siteSettingsModalTitle">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="siteSettingsModalTitle">Site Settings</h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close dialog"></button>
      </div>
      <div class="modal-body">
        <form id="site-settings-form" onsubmit="handleUpdateSite(event)" novalidate>
          <div class="mb-3">
            <label for="settings-site-id" class="form-label">Site ID</label>
            <input type="text" class="form-control" id="settings-site-id" readonly aria-readonly="true">
          </div>
          <div class="mb-3">
            <label for="settings-nickname" class="form-label">Nickname (optional)</label>
            <input
              type="text"
              class="form-control"
              id="settings-nickname"
              placeholder="My Website"
              aria-describedby="nickname-hint"
            >
            <div id="nickname-hint" class="form-text">A friendly name for this site</div>
          </div>
          <div class="mb-3">
            <label for="settings-domain" class="form-label">Domain</label>
            <input
              type="text"
              class="form-control"
              id="settings-domain"
              placeholder="example.com"
              required
              aria-required="true"
            >
          </div>
          <div class="alert alert-danger d-none" id="site-settings-error" role="alert" aria-live="polite"></div>
        </form>
        <hr>
        <div class="text-muted small mb-2" id="danger-zone-label">Danger Zone</div>
        <button
          class="btn btn-outline-danger w-100"
          onclick="confirmDeleteSite()"
          aria-describedby="danger-zone-label"
        >
          <i class="fas fa-trash me-2" aria-hidden="true"></i>Delete This Site
        </button>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="site-settings-form" class="btn btn-primary">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Onboarding Wizard Modal -->
<div class="modal fade" id="onboardingModal" tabindex="-1" aria-labelledby="onboardingModalTitle" data-bs-backdrop="static">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h2 class="modal-title h4" id="onboardingModalTitle">Welcome to Zero Trust Analytics!</h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body pt-2">
        <!-- Progress Steps -->
        <div class="d-flex justify-content-center mb-4">
          <div class="onboarding-steps d-flex align-items-center">
            <div class="step active" id="step-1-indicator">
              <span class="step-number">1</span>
              <span class="step-label d-none d-sm-inline">Add Site</span>
            </div>
            <div class="step-line"></div>
            <div class="step" id="step-2-indicator">
              <span class="step-number">2</span>
              <span class="step-label d-none d-sm-inline">Install</span>
            </div>
            <div class="step-line"></div>
            <div class="step" id="step-3-indicator">
              <span class="step-number">3</span>
              <span class="step-label d-none d-sm-inline">Verify</span>
            </div>
          </div>
        </div>

        <!-- Step 1: Add Site -->
        <div class="onboarding-step" id="onboarding-step-1">
          <div class="text-center mb-4">
            <i class="fas fa-globe fa-3x text-primary mb-3"></i>
            <h4>Add your first website</h4>
            <p class="text-muted">Enter your website domain to start tracking privacy-friendly analytics.</p>
          </div>
          <div class="mx-auto" style="max-width: 400px;">
            <div class="mb-3">
              <label for="onboarding-domain" class="form-label">Website Domain</label>
              <input type="text" class="form-control form-control-lg" id="onboarding-domain" placeholder="example.com">
              <div class="form-text">Enter without https://</div>
            </div>
            <div class="alert alert-danger d-none" id="onboarding-error"></div>
          </div>
        </div>

        <!-- Step 2: Install Script -->
        <div class="onboarding-step d-none" id="onboarding-step-2">
          <div class="text-center mb-4">
            <i class="fas fa-code fa-3x text-primary mb-3"></i>
            <h4>Install the tracking script</h4>
            <p class="text-muted">Add this code to your website's <code>&lt;head&gt;</code> tag.</p>
          </div>
          <div class="mx-auto" style="max-width: 600px;">
            <div class="position-relative">
              <pre class="bg-dark text-light p-3 rounded" style="font-size: 0.85rem;"><code id="onboarding-embed-code">&lt;script src="https://ztas.io/js/analytics.js" data-site-id="YOUR_SITE_ID"&gt;&lt;/script&gt;</code></pre>
              <button class="btn btn-sm btn-outline-light position-absolute top-0 end-0 m-2" onclick="copyOnboardingCode()">
                <i class="fas fa-copy me-1"></i>Copy
              </button>
            </div>
            <div class="alert alert-info mt-3">
              <i class="fas fa-lightbulb me-2"></i>
              <strong>Tip:</strong> Place this script right before the closing <code>&lt;/head&gt;</code> tag for best performance.
            </div>
          </div>
        </div>

        <!-- Step 3: Verify -->
        <div class="onboarding-step d-none" id="onboarding-step-3">
          <div class="text-center mb-4" id="verify-waiting">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">Checking...</span>
            </div>
            <h4>Waiting for first pageview...</h4>
            <p class="text-muted">Visit your website in another tab. We'll detect it automatically.</p>
            <p class="small text-muted mt-3">
              <i class="fas fa-clock me-1"></i>Checking every 5 seconds...
              <span id="verify-attempts">(0 attempts)</span>
            </p>
          </div>
          <div class="text-center mb-4 d-none" id="verify-success">
            <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
            <h4 class="text-success">Success! We received your first pageview!</h4>
            <p class="text-muted">Your analytics are now being tracked. Welcome aboard!</p>
            <div class="confetti-container" id="confetti"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-secondary" id="onboarding-back" onclick="onboardingBack()" style="display: none;">
          <i class="fas fa-arrow-left me-1"></i>Back
        </button>
        <button type="button" class="btn btn-primary" id="onboarding-next" onclick="onboardingNext()">
          Continue<i class="fas fa-arrow-right ms-1"></i>
        </button>
        <button type="button" class="btn btn-success d-none" id="onboarding-finish" data-bs-dismiss="modal" onclick="finishOnboarding()">
          Go to Dashboard<i class="fas fa-arrow-right ms-1"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<style>
/* Onboarding wizard styles */
.onboarding-steps {
  gap: 0.5rem;
}
.onboarding-steps .step {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: #6c757d;
}
.onboarding-steps .step.active {
  color: #0d6efd;
}
.onboarding-steps .step.completed {
  color: #198754;
}
.onboarding-steps .step-number {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #e9ecef;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
}
.onboarding-steps .step.active .step-number {
  background: #0d6efd;
  color: white;
}
.onboarding-steps .step.completed .step-number {
  background: #198754;
  color: white;
}
.onboarding-steps .step-line {
  width: 40px;
  height: 2px;
  background: #dee2e6;
}
@keyframes confetti-fall {
  0% { transform: translateY(-100%) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}
.confetti {
  position: fixed;
  width: 10px;
  height: 10px;
  top: 0;
  animation: confetti-fall 3s ease-out forwards;
}

.pulse-dot {
  width: 8px;
  height: 8px;
  background: white;
  border-radius: 50%;
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 0.75rem;
}
.stats-grid-secondary {
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
}
.stat-card {
  padding: 1rem;
  background: white;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.stat-card .stat-value {
  font-size: 1.5rem;
  font-weight: 600;
  word-break: break-word;
}
.stat-card-sm .stat-value {
  font-size: 1.25rem;
}
.stat-card .stat-label {
  font-size: 0.75rem;
  color: #6c757d;
  text-transform: uppercase;
}
.stat-card .stat-comparison {
  font-size: 0.75rem;
  margin-top: 0.25rem;
}
.stat-comparison .up {
  color: #198754;
}
.stat-comparison .down {
  color: #dc3545;
}
.stat-comparison .neutral {
  color: #6c757d;
}
.data-table {
  background: white;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  overflow: hidden;
}
.data-table .table {
  margin-bottom: 0;
  table-layout: fixed;
}
.data-table .table td, .data-table .table th {
  padding: 0.5rem 0.75rem;
  font-size: 0.8rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.data-table .table td:first-child {
  max-width: 200px;
}
.embed-code {
  background: #f8f9fa;
  padding: 0.75rem;
  border-radius: 4px;
  overflow-x: auto;
  font-size: 0.8rem;
}
.embed-code code {
  white-space: pre-wrap;
  word-break: break-all;
}
/* Loading skeleton */
.skeleton {
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: skeleton-loading 1.5s infinite;
  border-radius: 4px;
}
@keyframes skeleton-loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
.skeleton-text { height: 1rem; margin-bottom: 0.5rem; }
.skeleton-title { height: 1.5rem; width: 60%; margin-bottom: 0.75rem; }
.skeleton-stat { height: 2rem; width: 80%; }
.skeleton-chart { height: 200px; width: 100%; }
.skeleton-row { height: 2.5rem; margin-bottom: 0.25rem; }

/* Tab navigation styles */
#dashboardTabs {
  border-bottom: 2px solid #dee2e6;
  flex-wrap: nowrap;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
#dashboardTabs .nav-link {
  border: none;
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
  color: #6c757d;
  white-space: nowrap;
  padding: 0.75rem 1rem;
}
#dashboardTabs .nav-link:hover {
  border-color: transparent;
  color: #0d6efd;
}
#dashboardTabs .nav-link.active {
  border-bottom-color: #0d6efd;
  color: #0d6efd;
  background: none;
}

/* Tablet fixes */
@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
  }
  .card-header h5 {
    font-size: 1rem;
  }
  #dashboardTabs .nav-link {
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
  }
}

/* Mobile fixes */
@media (max-width: 576px) {
  .dashboard-container {
    padding-top: 0.5rem;
  }
  .dashboard-container h1 {
    font-size: 1.5rem;
  }
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
  }
  .stats-grid-secondary {
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
  }
  .stat-card {
    padding: 0.75rem;
  }
  .stat-card .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
  }
  .stat-card .stat-label {
    font-size: 0.65rem;
  }
  .stat-card-sm .stat-value {
    font-size: 1.1rem;
  }
  .d-flex.gap-2 {
    flex-wrap: wrap;
  }
  /* Touch-friendly period selector */
  .period-selector {
    flex-wrap: nowrap;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 0.25rem;
  }
  .period-selector .btn {
    padding: 0.5rem 0.75rem;
    font-size: 0.8rem;
    white-space: nowrap;
    min-height: 44px;
  }
  /* Card-based tables on mobile */
  .data-table {
    margin-bottom: 1rem;
  }
  .data-table .table {
    display: block;
  }
  .data-table .table thead {
    display: none;
  }
  .data-table .table tbody {
    display: block;
  }
  .data-table .table tr {
    display: flex;
    flex-wrap: wrap;
    padding: 0.75rem;
    border-bottom: 1px solid #dee2e6;
    align-items: center;
  }
  .data-table .table td {
    border: none;
    padding: 0.25rem 0;
    font-size: 0.85rem;
  }
  .data-table .table td:first-child {
    flex: 1 1 70%;
    font-weight: 500;
    max-width: none;
  }
  .data-table .table td:last-child,
  .data-table .table td.text-end {
    flex: 0 0 auto;
    text-align: right;
    font-weight: 600;
    color: #0d6efd;
  }
  /* Hide date pickers on mobile - use period buttons */
  fieldset.d-flex {
    display: none !important;
  }
  /* Larger touch targets */
  .btn {
    min-height: 44px;
    min-width: 44px;
  }
  .btn-sm {
    min-height: 38px;
    padding: 0.5rem 0.75rem;
  }
  /* Site selector full width */
  .site-selector {
    width: 100%;
  }
  .site-selector .form-select {
    flex: 1;
  }
  /* Real-time badge */
  .bg-success.text-white {
    font-size: 0.9rem;
    padding: 0.5rem 0.75rem !important;
  }
  /* Charts responsive */
  .card-body canvas {
    max-height: 200px;
  }
  /* Export buttons stack */
  .d-flex.gap-2.flex-wrap {
    gap: 0.5rem !important;
  }
  .d-flex.gap-2.flex-wrap .btn {
    flex: 1 1 calc(50% - 0.25rem);
    font-size: 0.75rem;
  }
}

/* Print styles for PDF export */
@media print {
  /* Hide non-essential elements */
  header, footer, nav,
  .navbar, .trial-banner, .expired-banner,
  #site-settings-btn, #empty-state,
  .period-selector, .date-range-picker,
  .btn-group, .dropdown, .modal,
  #loading-skeleton,
  button:not(.print-include),
  .btn:not(.print-include) {
    display: none !important;
  }

  /* Reset colors for print */
  body, .card, .stat-card {
    background: white !important;
    color: black !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }

  /* Page setup */
  @page {
    size: A4 portrait;
    margin: 1.5cm;
  }

  /* Print header */
  .print-header {
    display: block !important;
    text-align: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #0d6efd;
  }

  .print-header h1 {
    font-size: 1.5rem;
    margin: 0;
  }

  .print-header .print-meta {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.25rem;
  }

  /* Cards layout */
  .stat-card {
    break-inside: avoid;
    border: 1px solid #ddd !important;
    box-shadow: none !important;
    margin-bottom: 0.5rem;
  }

  .card {
    break-inside: avoid;
    border: 1px solid #ddd !important;
    box-shadow: none !important;
    page-break-inside: avoid;
  }

  /* Tables */
  table {
    font-size: 0.85rem;
  }

  /* Charts - ensure they print */
  canvas {
    max-width: 100% !important;
    height: auto !important;
  }

  /* Show all tab content */
  .tab-pane {
    display: block !important;
    opacity: 1 !important;
  }

  .nav-tabs {
    display: none !important;
  }

  /* Grid adjustments */
  .row {
    display: flex !important;
    flex-wrap: wrap !important;
  }

  .col-md-3, .col-lg-3 {
    width: 25% !important;
    flex: 0 0 25% !important;
  }

  .col-md-6, .col-lg-6 {
    width: 50% !important;
    flex: 0 0 50% !important;
  }

  /* Footer */
  .print-footer {
    display: block !important;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    text-align: center;
    font-size: 0.75rem;
    color: #999;
    border-top: 1px solid #ddd;
    padding-top: 0.25rem;
  }
}

/* Hidden print elements (shown only when printing) */
.print-header, .print-footer {
  display: none;
}
</style>
{{ end }}
