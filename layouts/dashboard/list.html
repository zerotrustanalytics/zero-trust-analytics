{{ define "main" }}
<!-- Sliding Sidebar -->
<aside id="dashboard-sidebar" class="dashboard-sidebar" aria-label="Dashboard navigation">
  <div class="sidebar-header">
    <span class="sidebar-brand">ZTA</span>
    <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">
      <i class="fas fa-bars"></i>
    </button>
  </div>

  <nav class="sidebar-nav">
    <!-- Analytics Section -->
    <div class="sidebar-section">
      <span class="sidebar-section-title">Analytics</span>
      <button class="sidebar-item active" onclick="scrollToStats()" aria-label="Dashboard overview">
        <i class="fas fa-chart-line"></i>
        <span>Overview</span>
      </button>
      <button class="sidebar-item" onclick="openGoalsModal()" aria-label="Track goals">
        <i class="fas fa-bullseye"></i>
        <span>Goals</span>
      </button>
      <button class="sidebar-item" onclick="openFunnelsModal()" aria-label="Funnel analysis">
        <i class="fas fa-filter"></i>
        <span>Funnels</span>
      </button>
      <button class="sidebar-item" onclick="openHeatmapsModal()" aria-label="View heatmaps">
        <i class="fas fa-fire"></i>
        <span>Heatmaps</span>
      </button>
      <button class="sidebar-item" onclick="openGSCModal()" aria-label="Google Search Console">
        <i class="fas fa-search"></i>
        <span>Search Console</span>
      </button>
    </div>

    <!-- Data Section -->
    <div class="sidebar-section">
      <span class="sidebar-section-title">Data</span>
      <button class="sidebar-item" onclick="openExportDropdown()" aria-label="Export data">
        <i class="fas fa-download"></i>
        <span>Export</span>
      </button>
      <button class="sidebar-item" onclick="openImportModal()" aria-label="Import Google Analytics">
        <i class="fas fa-upload"></i>
        <span>Import GA</span>
      </button>
      <button class="sidebar-item" onclick="openShareModal()" aria-label="Share dashboard">
        <i class="fas fa-share-alt"></i>
        <span>Share</span>
      </button>
    </div>

    <!-- Settings Section -->
    <div class="sidebar-section">
      <span class="sidebar-section-title">Settings</span>
      <button class="sidebar-item" data-bs-toggle="modal" data-bs-target="#addSiteModal" aria-label="Add site">
        <i class="fas fa-plus-circle"></i>
        <span>Add Site</span>
      </button>
      <button class="sidebar-item" onclick="openSiteSettings()" aria-label="Site settings">
        <i class="fas fa-cog"></i>
        <span>Site Settings</span>
      </button>
      <button class="sidebar-item" onclick="openApiKeysModal()" aria-label="API Keys">
        <i class="fas fa-key"></i>
        <span>API Keys</span>
      </button>
      <button class="sidebar-item" onclick="openWebhooksModal()" aria-label="Webhooks">
        <i class="fas fa-bolt"></i>
        <span>Webhooks</span>
      </button>
      <button class="sidebar-item" onclick="openAlertsModal()" aria-label="Alerts">
        <i class="fas fa-bell"></i>
        <span>Alerts</span>
      </button>
    </div>

    <!-- Account Section -->
    <div class="sidebar-section">
      <span class="sidebar-section-title">Account</span>
      <button class="sidebar-item" onclick="openTeamsModal()" aria-label="Team management">
        <i class="fas fa-users"></i>
        <span>Team</span>
      </button>
      <button class="sidebar-item" onclick="openSessionsModal()" aria-label="Active sessions">
        <i class="fas fa-shield-alt"></i>
        <span>Sessions</span>
      </button>
      <button class="sidebar-item" onclick="openActivityModal()" aria-label="Activity log">
        <i class="fas fa-history"></i>
        <span>Activity</span>
      </button>
      <button class="sidebar-item" onclick="openBillingPortal()" aria-label="Billing">
        <i class="fas fa-credit-card"></i>
        <span>Billing</span>
      </button>
    </div>
  </nav>

  <!-- Sidebar Footer -->
  <div class="sidebar-footer">
    <button class="sidebar-item" onclick="logout()" aria-label="Logout">
      <i class="fas fa-sign-out-alt"></i>
      <span>Logout</span>
    </button>
  </div>
</aside>

<!-- Mobile Sidebar Overlay -->
<div id="sidebar-overlay" class="sidebar-overlay" onclick="closeSidebar()"></div>

<!-- Main Dashboard Content -->
<div class="dashboard-main">
  <div class="dashboard-container">
    <div class="container-fluid px-4">
      <!-- Mobile Header -->
      <div class="mobile-header d-lg-none mb-3">
        <button class="btn btn-outline-secondary" onclick="openSidebar()" aria-label="Open menu">
          <i class="fas fa-bars"></i>
        </button>
        <span class="mobile-title">Dashboard</span>
      </div>

      <!-- Trial Banner (shown via JS) -->
      <div id="trial-banner" class="alert alert-warning d-none mb-4" role="alert">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div>
            <strong id="trial-status-text">14 days left in your free trial</strong>
            <span class="d-block d-sm-inline ms-sm-2 text-muted small">Upgrade to continue tracking after your trial ends.</span>
          </div>
          <a href="/#pricing" class="btn btn-warning btn-sm">Upgrade Now</a>
        </div>
      </div>

      <!-- Expired Banner (shown via JS) -->
      <div id="expired-banner" class="alert alert-danger d-none mb-4" role="alert">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div>
            <strong>Your free trial has ended</strong>
            <span class="d-block d-sm-inline ms-sm-2">Upgrade to continue using Zero Trust Analytics.</span>
          </div>
          <a href="/#pricing" class="btn btn-danger btn-sm">Choose a Plan</a>
        </div>
      </div>

      <!-- Header - Clean and minimal -->
      <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <div>
          <h1 class="h3 mb-1 d-none d-lg-block">Dashboard</h1>
          <p class="text-muted mb-0" id="current-site-domain" aria-live="polite">Select a site to view analytics</p>
        </div>
        <button class="btn btn-primary d-none d-lg-inline-flex" data-bs-toggle="modal" data-bs-target="#addSiteModal" aria-label="Add a new site">
          <i class="fas fa-plus me-1" aria-hidden="true"></i>Add Site
        </button>
      </div>

    <!-- Site Selector, Period & Date Range -->
    <div class="d-flex flex-wrap gap-3 mb-4 align-items-center" role="region" aria-label="Analytics filters">
      <div class="site-selector d-flex gap-2">
        <label for="site-selector" class="visually-hidden">Select a site</label>
        <select class="form-select" id="site-selector" onchange="loadStats()" aria-describedby="site-selector-help">
          <option value="">Select a site...</option>
        </select>
        <span id="site-selector-help" class="visually-hidden">Choose a website to view its analytics</span>
        <button class="btn btn-outline-secondary" id="site-settings-btn" onclick="openSiteSettings()" aria-label="Open site settings">
          <i class="fas fa-cog" aria-hidden="true"></i>
        </button>
      </div>
      <div class="period-selector btn-group" role="group" aria-label="Select time period">
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPeriod('24h')" aria-pressed="false">24h</button>
        <button type="button" class="btn btn-outline-secondary btn-sm active" onclick="setPeriod('7d')" aria-pressed="true">7d</button>
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPeriod('30d')" aria-pressed="false">30d</button>
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPeriod('90d')" aria-pressed="false">90d</button>
        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPeriod('365d')" aria-pressed="false">1y</button>
      </div>
      <!-- Date Range Presets -->
      <div class="dropdown">
        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="datePresetDropdown" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-calendar-range me-1"></i>Quick Range
        </button>
        <ul class="dropdown-menu" aria-labelledby="datePresetDropdown">
          <li><h6 class="dropdown-header">Relative</h6></li>
          <li><a class="dropdown-item" href="#" onclick="setDatePreset('today'); return false;">Today</a></li>
          <li><a class="dropdown-item" href="#" onclick="setDatePreset('yesterday'); return false;">Yesterday</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><h6 class="dropdown-header">This Period</h6></li>
          <li><a class="dropdown-item" href="#" onclick="setDatePreset('this-week'); return false;">This Week</a></li>
          <li><a class="dropdown-item" href="#" onclick="setDatePreset('this-month'); return false;">This Month</a></li>
          <li><a class="dropdown-item" href="#" onclick="setDatePreset('this-quarter'); return false;">This Quarter</a></li>
          <li><a class="dropdown-item" href="#" onclick="setDatePreset('this-year'); return false;">This Year</a></li>
          <li><hr class="dropdown-divider"></li>
          <li><h6 class="dropdown-header">Last Period</h6></li>
          <li><a class="dropdown-item" href="#" onclick="setDatePreset('last-week'); return false;">Last Week</a></li>
          <li><a class="dropdown-item" href="#" onclick="setDatePreset('last-month'); return false;">Last Month</a></li>
          <li><a class="dropdown-item" href="#" onclick="setDatePreset('last-quarter'); return false;">Last Quarter</a></li>
          <li><a class="dropdown-item" href="#" onclick="setDatePreset('last-year'); return false;">Last Year</a></li>
        </ul>
      </div>
      <fieldset class="d-flex gap-2 align-items-center">
        <legend class="visually-hidden">Custom date range</legend>
        <label for="start-date" class="visually-hidden">Start date</label>
        <input type="date" class="form-control form-control-sm" id="start-date" onchange="loadStatsCustomRange()">
        <span class="text-muted" aria-hidden="true">to</span>
        <label for="end-date" class="visually-hidden">End date</label>
        <input type="date" class="form-control form-control-sm" id="end-date" onchange="loadStatsCustomRange()">
      </fieldset>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="compare-toggle" onchange="toggleComparison()">
        <label class="form-check-label small" for="compare-toggle">Compare to previous period</label>
      </div>
    </div>

    <!-- Empty State (shown when no sites) -->
    <div class="empty-state" id="empty-state">
      <div class="empty-icon">
        <i class="fas fa-chart-line"></i>
      </div>
      <h3>No sites yet</h3>
      <p>Add your first website to start tracking anonymous analytics.</p>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSiteModal">
        <i class="fas fa-plus me-2"></i>Add Your First Site
      </button>
    </div>

    <!-- Loading Skeleton (shown while loading) -->
    <div id="loading-skeleton" style="display: none;">
      <div class="mb-4">
        <div class="skeleton" style="width: 200px; height: 40px; border-radius: 20px;"></div>
      </div>
      <div class="stats-grid mb-4">
        <div class="stat-card"><div class="skeleton skeleton-stat"></div><div class="skeleton skeleton-text" style="width: 60%;"></div></div>
        <div class="stat-card"><div class="skeleton skeleton-stat"></div><div class="skeleton skeleton-text" style="width: 60%;"></div></div>
        <div class="stat-card"><div class="skeleton skeleton-stat"></div><div class="skeleton skeleton-text" style="width: 60%;"></div></div>
        <div class="stat-card"><div class="skeleton skeleton-stat"></div><div class="skeleton skeleton-text" style="width: 60%;"></div></div>
      </div>
      <div class="row mb-4">
        <div class="col-lg-8 mb-4"><div class="card"><div class="card-header"><div class="skeleton skeleton-text" style="width: 40%;"></div></div><div class="card-body"><div class="skeleton skeleton-chart"></div></div></div></div>
        <div class="col-lg-4"><div class="card"><div class="card-header"><div class="skeleton skeleton-text" style="width: 50%;"></div></div><div class="card-body"><div class="skeleton skeleton-chart"></div></div></div></div>
      </div>
      <div class="row">
        <div class="col-lg-6 mb-4"><div class="data-table"><div class="p-3 bg-light"><div class="skeleton skeleton-text" style="width: 30%;"></div></div><div class="p-3"><div class="skeleton skeleton-row"></div><div class="skeleton skeleton-row"></div><div class="skeleton skeleton-row"></div></div></div></div>
        <div class="col-lg-6 mb-4"><div class="data-table"><div class="p-3 bg-light"><div class="skeleton skeleton-text" style="width: 30%;"></div></div><div class="p-3"><div class="skeleton skeleton-row"></div><div class="skeleton skeleton-row"></div><div class="skeleton skeleton-row"></div></div></div></div>
      </div>
    </div>

    <!-- Stats Content (hidden until site selected) -->
    <div id="stats-content" style="display: none;">

      <!-- Print Header (only visible when printing) -->
      <div class="print-header">
        <h1>Zero Trust Analytics Report</h1>
        <div class="print-meta">
          <span id="print-site-name"></span> &bull;
          <span id="print-date-range"></span> &bull;
          Generated <span id="print-timestamp"></span>
        </div>
      </div>

      <!-- Real-time Badge -->
      <div class="mb-4 d-flex flex-wrap gap-3 align-items-center">
        <div class="d-inline-flex align-items-center bg-success text-white px-3 py-2 rounded">
          <span class="pulse-dot me-2"></span>
          <span id="active-visitors">0</span> active visitor(s) right now
        </div>
        <div class="d-inline-flex align-items-center gap-2" id="realtime-sources" style="display: none !important;">
          <!-- Populated by JS -->
        </div>
      </div>

      <!-- Primary Stats Grid -->
      <div class="stats-grid mb-4">
        <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Number of distinct visitors (privacy-safe daily hash)">
          <div class="stat-value" id="unique-visitors">-</div>
          <div class="stat-label">Unique Visitors <i class="fas fa-info-circle text-muted small" aria-hidden="true"></i></div>
          <div class="stat-comparison" id="unique-visitors-compare"></div>
        </div>
        <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Total pages viewed across all visitors">
          <div class="stat-value" id="page-views">-</div>
          <div class="stat-label">Page Views <i class="fas fa-info-circle text-muted small" aria-hidden="true"></i></div>
          <div class="stat-comparison" id="page-views-compare"></div>
        </div>
        <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="bottom" title="A session ends after 30 minutes of inactivity">
          <div class="stat-value" id="sessions">-</div>
          <div class="stat-label">Sessions <i class="fas fa-info-circle text-muted small" aria-hidden="true"></i></div>
          <div class="stat-comparison" id="sessions-compare"></div>
        </div>
        <div class="stat-card" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Visitors who left after viewing only one page (lower is better)">
          <div class="stat-value" id="bounce-rate">-</div>
          <div class="stat-label">Bounce Rate <i class="fas fa-info-circle text-muted small" aria-hidden="true"></i></div>
          <div class="stat-comparison" id="bounce-rate-compare"></div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="row mb-4">
        <div class="col-lg-8 mb-4 mb-lg-0">
          <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Visitors & Pageviews</h5>
              <button class="btn btn-sm btn-outline-secondary" onclick="openAnnotationModal()" title="Add annotation">
                <i class="bi bi-pin-angle me-1"></i>Annotate
              </button>
            </div>
            <div class="card-body">
              <canvas id="visitors-chart" height="250"></canvas>
              <!-- Annotation markers populated by JS -->
              <div id="chart-annotations" class="mt-2 d-none">
                <small class="text-muted">Annotations:</small>
                <div id="annotation-list" class="d-flex flex-wrap gap-2 mt-1"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card h-100">
            <div class="card-header">
              <h5 class="mb-0">Traffic Sources</h5>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center">
              <canvas id="sources-chart" height="200"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Additional Charts Row -->
      <div class="row mb-4">
        <div class="col-lg-6 mb-4 mb-lg-0">
          <div class="card h-100">
            <div class="card-header">
              <h5 class="mb-0">Devices</h5>
            </div>
            <div class="card-body">
              <canvas id="devices-chart" height="200"></canvas>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card h-100">
            <div class="card-header">
              <h5 class="mb-0">Browsers</h5>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center">
              <canvas id="browsers-chart" height="200"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Secondary Stats Grid -->
      <div class="stats-grid stats-grid-secondary mb-4">
        <div class="stat-card stat-card-sm" data-bs-toggle="tooltip" title="Average time visitors spend on your site per session">
          <div class="stat-value" id="avg-session-duration">-</div>
          <div class="stat-label">Avg. Session Duration</div>
        </div>
        <div class="stat-card stat-card-sm" data-bs-toggle="tooltip" title="Average number of pages viewed per session">
          <div class="stat-value" id="pages-per-session">-</div>
          <div class="stat-label">Pages / Session</div>
        </div>
        <div class="stat-card stat-card-sm" data-bs-toggle="tooltip" title="How far visitors scroll down your pages on average">
          <div class="stat-value" id="avg-scroll-depth">-</div>
          <div class="stat-label">Avg. Scroll Depth</div>
        </div>
        <div class="stat-card stat-card-sm" data-bs-toggle="tooltip" title="First-time visitors vs returning visitors (based on daily hash)">
          <div class="stat-value" id="new-vs-returning">-</div>
          <div class="stat-label">New / Returning</div>
        </div>
      </div>

      <!-- Tab Navigation -->
      <ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="pages-tab" data-bs-toggle="tab" data-bs-target="#pages-panel" type="button" role="tab" aria-controls="pages-panel" aria-selected="true">
            <i class="fas fa-file-alt me-1 d-none d-sm-inline" aria-hidden="true"></i>Pages
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="sources-tab" data-bs-toggle="tab" data-bs-target="#sources-panel" type="button" role="tab" aria-controls="sources-panel" aria-selected="false">
            <i class="fas fa-link me-1 d-none d-sm-inline" aria-hidden="true"></i>Sources
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tech-tab" data-bs-toggle="tab" data-bs-target="#tech-panel" type="button" role="tab" aria-controls="tech-panel" aria-selected="false">
            <i class="fas fa-laptop me-1 d-none d-sm-inline" aria-hidden="true"></i>Tech
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="geo-tab" data-bs-toggle="tab" data-bs-target="#geo-panel" type="button" role="tab" aria-controls="geo-panel" aria-selected="false">
            <i class="fas fa-globe me-1 d-none d-sm-inline" aria-hidden="true"></i>Geo
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="events-tab" data-bs-toggle="tab" data-bs-target="#events-panel" type="button" role="tab" aria-controls="events-panel" aria-selected="false">
            <i class="fas fa-bolt me-1 d-none d-sm-inline" aria-hidden="true"></i>Events
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content" id="dashboardTabContent">
        <!-- Pages Tab -->
        <div class="tab-pane fade show active" id="pages-panel" role="tabpanel" aria-labelledby="pages-tab">
          <div class="row">
            <div class="col-lg-6 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light d-flex justify-content-between align-items-center">
                  Top Pages
                  <span class="badge bg-secondary" id="pages-count">0</span>
                </h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Page</th>
                      <th class="text-end">Views</th>
                      <th class="text-end">Avg Time</th>
                    </tr>
                  </thead>
                  <tbody id="top-pages-table">
                    <tr><td colspan="3" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-lg-6 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light">Landing Pages</h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Page</th>
                      <th class="text-end">Entrances</th>
                    </tr>
                  </thead>
                  <tbody id="landing-pages-table">
                    <tr><td colspan="2" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-6 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light">Exit Pages</h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Page</th>
                      <th class="text-end">Exits</th>
                    </tr>
                  </thead>
                  <tbody id="exit-pages-table">
                    <tr><td colspan="2" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-12 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light d-flex justify-content-between align-items-center">
                  <span><i class="bi bi-exclamation-triangle me-2"></i>404 Errors &amp; Issues</span>
                  <span class="badge bg-danger" id="errors-count">0</span>
                </h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>URL</th>
                      <th>Type</th>
                      <th class="text-end">Count</th>
                      <th>Last Seen</th>
                      <th>Referrer</th>
                    </tr>
                  </thead>
                  <tbody id="errors-table">
                    <tr><td colspan="5" class="text-center text-muted">No errors tracked</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Sources Tab -->
        <div class="tab-pane fade" id="sources-panel" role="tabpanel" aria-labelledby="sources-tab">
          <div class="row">
            <div class="col-lg-6 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light d-flex justify-content-between align-items-center">
                  Top Referrers
                  <span class="badge bg-secondary" id="referrers-count">0</span>
                </h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Source</th>
                      <th class="text-end">Visits</th>
                    </tr>
                  </thead>
                  <tbody id="top-referrers-table">
                    <tr><td colspan="2" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-lg-6 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light">Traffic Sources</h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Source Type</th>
                      <th class="text-end">Visits</th>
                    </tr>
                  </thead>
                  <tbody id="traffic-sources-table">
                    <tr><td colspan="2" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-6 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light">UTM Campaigns</h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Campaign</th>
                      <th class="text-end">Visits</th>
                    </tr>
                  </thead>
                  <tbody id="campaigns-table">
                    <tr><td colspan="2" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Tech Tab -->
        <div class="tab-pane fade" id="tech-panel" role="tabpanel" aria-labelledby="tech-tab">
          <div class="row">
            <div class="col-lg-4 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light">Devices</h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Device</th>
                      <th class="text-end">Visits</th>
                    </tr>
                  </thead>
                  <tbody id="devices-table">
                    <tr><td colspan="2" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-lg-4 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light">Browsers</h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Browser</th>
                      <th class="text-end">Visits</th>
                    </tr>
                  </thead>
                  <tbody id="browsers-table">
                    <tr><td colspan="2" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-lg-4 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light">Operating Systems</h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>OS</th>
                      <th class="text-end">Visits</th>
                    </tr>
                  </thead>
                  <tbody id="os-table">
                    <tr><td colspan="2" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Geo Tab -->
        <div class="tab-pane fade" id="geo-panel" role="tabpanel" aria-labelledby="geo-tab">
          <div class="row">
            <div class="col-lg-4 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light">Countries</h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Country</th>
                      <th class="text-end">Visitors</th>
                    </tr>
                  </thead>
                  <tbody id="countries-table">
                    <tr><td colspan="2" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="col-lg-4 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light">Languages</h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Language</th>
                      <th class="text-end">Visits</th>
                    </tr>
                  </thead>
                  <tbody id="languages-table">
                    <tr><td colspan="2" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Events Tab -->
        <div class="tab-pane fade" id="events-panel" role="tabpanel" aria-labelledby="events-tab">
          <div class="row">
            <div class="col-12 mb-4">
              <div class="data-table">
                <h5 class="p-3 mb-0 bg-light d-flex justify-content-between align-items-center">
                  <span>Custom Events <small class="text-muted">(<span id="total-events">0</span> total)</small></span>
                  <span class="badge bg-primary" id="events-value-total" style="display:none;">$0</span>
                </h5>
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>Event</th>
                      <th>Details</th>
                      <th class="text-end">Count</th>
                      <th class="text-end">Value</th>
                    </tr>
                  </thead>
                  <tbody id="events-table">
                    <tr><td colspan="4" class="text-center text-muted">No data yet</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div><!-- End tab-content -->

      <!-- Embed Code -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Embed Code</h5>
          <button class="btn btn-sm btn-outline-primary" onclick="copyEmbedCode()">
            <i class="fas fa-copy me-1"></i>Copy
          </button>
        </div>
        <div class="card-body">
          <p class="text-muted small mb-2">Add this script to your website's <code>&lt;head&gt;</code> tag:</p>
          <div class="embed-code">
            <code id="embed-code">&lt;script src="https://ztas.io/js/analytics.js" data-site-id="YOUR_SITE_ID"&gt;&lt;/script&gt;</code>
          </div>
          <div class="mt-3">
            <p class="text-muted small mb-1">Optional attributes:</p>
            <ul class="small text-muted mb-0">
              <li><code>data-spa="true"</code> - Enable SPA route tracking</li>
              <li><code>data-debug="true"</code> - Enable console logging</li>
              <li><code>data-track-scroll="false"</code> - Disable scroll tracking</li>
              <li><code>data-track-outbound="false"</code> - Disable outbound link tracking</li>
              <li><code>data-track-forms="false"</code> - Disable form submission tracking</li>
            </ul>
          </div>
          <div class="mt-3">
            <p class="text-muted small mb-1">Custom event tracking:</p>
            <pre class="bg-light p-2 rounded small mb-0"><code>// Track simple events
ZTA.track('signup');
ZTA.track('button_click');

// Track events with properties
ZTA.track('purchase', { amount: 99 });
ZTA.track('download', { file: 'report.pdf' });</code></pre>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Annotation Modal -->
<div class="modal fade" id="annotationModal" tabindex="-1" aria-labelledby="annotationModalTitle">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="annotationModalTitle">
          <i class="bi bi-pin-angle me-2"></i>Chart Annotations
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Mark important events on your analytics chart.</p>

        <!-- No Site Selected Warning -->
        <div id="annotation-no-site" class="alert alert-info d-none">
          <i class="bi bi-info-circle me-2"></i>Please select a site first.
        </div>

        <!-- Create New Annotation -->
        <div class="card mb-4" id="annotation-create-section">
          <div class="card-header">
            <h6 class="mb-0">Add Annotation</h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Date</label>
                <input type="date" class="form-control" id="new-annotation-date">
              </div>
              <div class="col-md-6">
                <label class="form-label">Icon</label>
                <select class="form-select" id="new-annotation-icon">
                  <option value="star">‚≠ê Star</option>
                  <option value="rocket">üöÄ Launch</option>
                  <option value="megaphone">üì£ Campaign</option>
                  <option value="flag">üö© Milestone</option>
                  <option value="bug">üêõ Bug Fix</option>
                  <option value="gift">üéÅ Release</option>
                </select>
              </div>
            </div>
            <div class="mt-3">
              <label class="form-label">Title</label>
              <input type="text" class="form-control" id="new-annotation-title" placeholder="e.g., Product Launch">
            </div>
            <div class="mt-3">
              <label class="form-label">Description <span class="text-muted">(optional)</span></label>
              <textarea class="form-control" id="new-annotation-description" rows="2" placeholder="Brief description..."></textarea>
            </div>
            <div class="mt-3">
              <label class="form-label">Color</label>
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-primary btn-sm annotation-color active" data-color="#0d6efd" style="width: 32px; height: 32px;"></button>
                <button type="button" class="btn btn-success btn-sm annotation-color" data-color="#198754" style="width: 32px; height: 32px;"></button>
                <button type="button" class="btn btn-warning btn-sm annotation-color" data-color="#ffc107" style="width: 32px; height: 32px;"></button>
                <button type="button" class="btn btn-danger btn-sm annotation-color" data-color="#dc3545" style="width: 32px; height: 32px;"></button>
                <button type="button" class="btn btn-info btn-sm annotation-color" data-color="#0dcaf0" style="width: 32px; height: 32px;"></button>
                <button type="button" class="btn btn-dark btn-sm annotation-color" data-color="#212529" style="width: 32px; height: 32px;"></button>
              </div>
            </div>
            <button class="btn btn-primary mt-3" onclick="createAnnotation()">
              <i class="bi bi-plus-lg me-1"></i>Add Annotation
            </button>
          </div>
        </div>

        <!-- Existing Annotations -->
        <h6 class="text-muted mb-3">Your Annotations</h6>
        <div id="annotations-loading" class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <span class="ms-2">Loading annotations...</span>
        </div>

        <div id="annotations-list" class="d-none">
          <!-- Annotations populated by JS -->
        </div>

        <div id="annotations-empty" class="d-none text-center py-4 text-muted">
          <i class="bi bi-pin-angle" style="font-size: 2rem;"></i>
          <p class="mt-2">No annotations yet</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Teams Modal -->
<div class="modal fade" id="teamsModal" tabindex="-1" aria-labelledby="teamsModalTitle">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="teamsModalTitle">
          <i class="bi bi-people me-2"></i>Team Management
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Collaborate with your team by sharing access to your analytics dashboards.</p>

        <!-- No Team Yet -->
        <div id="teams-no-team" class="text-center py-4 d-none">
          <i class="bi bi-people" style="font-size: 3rem; color: #6c757d;"></i>
          <h5 class="mt-3">You're not part of any team yet</h5>
          <p class="text-muted">Create a team to collaborate with others.</p>
          <button class="btn btn-primary" onclick="showCreateTeamForm()">
            <i class="bi bi-plus-lg me-1"></i>Create Team
          </button>
        </div>

        <!-- Create Team Form (hidden by default) -->
        <div id="team-create-form" class="card mb-4 d-none">
          <div class="card-header">
            <h6 class="mb-0">Create New Team</h6>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Team Name</label>
              <input type="text" class="form-control" id="new-team-name" placeholder="e.g., My Company">
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-primary" onclick="createTeam()">
                <i class="bi bi-plus-lg me-1"></i>Create Team
              </button>
              <button class="btn btn-outline-secondary" onclick="hideCreateTeamForm()">Cancel</button>
            </div>
          </div>
        </div>

        <!-- Team Selector (when multiple teams) -->
        <div id="team-selector-section" class="mb-4 d-none">
          <label class="form-label">Select Team</label>
          <select class="form-select" id="team-selector" onchange="loadTeamDetails()">
            <option value="">Select a team...</option>
          </select>
        </div>

        <!-- Team Details -->
        <div id="team-details" class="d-none">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0" id="current-team-name">Team Name</h5>
            <span class="badge bg-primary" id="current-user-role">Owner</span>
          </div>

          <!-- Invite Member Section -->
          <div class="card mb-4" id="team-invite-section">
            <div class="card-header">
              <h6 class="mb-0"><i class="bi bi-person-plus me-2"></i>Invite Team Member</h6>
            </div>
            <div class="card-body">
              <div class="row g-2">
                <div class="col-md-5">
                  <label for="invite-email" class="visually-hidden">Email address of team member to invite</label>
                  <input type="email" class="form-control" id="invite-email" placeholder="colleague@company.com" aria-label="Email address of team member to invite">
                </div>
                <div class="col-md-4">
                  <select class="form-select" id="invite-role">
                    <option value="viewer">Viewer (read-only)</option>
                    <option value="editor">Editor (can edit)</option>
                    <option value="admin">Admin (full access)</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <button class="btn btn-primary w-100" onclick="inviteTeamMember()">
                    <i class="bi bi-send me-1"></i>Invite
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Invite Link Display -->
          <div class="alert alert-success d-none" id="invite-success">
            <h6 class="alert-heading"><i class="bi bi-check-circle me-2"></i>Invite Sent!</h6>
            <p class="mb-2">Share this link with <strong id="invite-email-display"></strong>:</p>
            <div class="input-group mb-2">
              <input type="text" class="form-control font-monospace small" id="invite-link" readonly>
              <button class="btn btn-outline-secondary" onclick="copyInviteLink()">
                <i class="bi bi-clipboard"></i>
              </button>
            </div>
            <small class="text-muted">This link expires in 7 days.</small>
          </div>

          <!-- Pending Invites -->
          <div id="team-invites-section" class="mb-4 d-none">
            <h6 class="text-muted mb-3"><i class="bi bi-clock me-2"></i>Pending Invites</h6>
            <div id="team-invites-list"></div>
          </div>

          <!-- Team Members -->
          <h6 class="text-muted mb-3"><i class="bi bi-people me-2"></i>Team Members</h6>
          <div id="teams-loading" class="text-center py-4">
            <div class="spinner-border spinner-border-sm text-primary"></div>
            <span class="ms-2">Loading team...</span>
          </div>

          <div id="team-members-list" class="d-none">
            <!-- Members populated by JS -->
          </div>

          <!-- Add Sites to Team -->
          <div class="card mt-4" id="team-sites-section">
            <div class="card-header">
              <h6 class="mb-0"><i class="bi bi-globe me-2"></i>Team Sites</h6>
            </div>
            <div class="card-body">
              <p class="text-muted small mb-3">Sites shared with the team will be accessible to all members based on their role.</p>
              <div class="row g-2 mb-3">
                <div class="col-md-8">
                  <select class="form-select" id="site-to-add">
                    <option value="">Select a site to share...</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <button class="btn btn-outline-primary w-100" onclick="addSiteToTeam()">
                    <i class="bi bi-plus-lg me-1"></i>Add to Team
                  </button>
                </div>
              </div>
              <div id="team-sites-list" class="small">
                <!-- Sites populated by JS -->
              </div>
            </div>
          </div>

          <!-- Team Actions -->
          <div class="mt-4 pt-3 border-top" id="team-actions">
            <button class="btn btn-outline-danger btn-sm" onclick="leaveCurrentTeam()">
              <i class="bi bi-box-arrow-left me-1"></i>Leave Team
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Goals Modal -->
<div class="modal fade" id="goalsModal" tabindex="-1" aria-labelledby="goalsModalTitle">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="goalsModalTitle">
          <i class="bi bi-bullseye me-2"></i>Goal Tracking
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Set targets for your key metrics and track progress over time.</p>

        <!-- No Site Selected Warning -->
        <div id="goals-no-site" class="alert alert-info d-none">
          <i class="bi bi-info-circle me-2"></i>Please select a site first to manage goals.
        </div>

        <!-- Create New Goal -->
        <div class="card mb-4" id="goal-create-section">
          <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Create New Goal</h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Goal Name</label>
                <input type="text" class="form-control" id="new-goal-name" placeholder="e.g., 10K Monthly Visitors">
              </div>
              <div class="col-md-6">
                <label class="form-label">Metric</label>
                <select class="form-select" id="new-goal-metric">
                  <option value="pageviews">Pageviews</option>
                  <option value="visitors">Unique Visitors</option>
                  <option value="sessions">Sessions</option>
                  <option value="events">Custom Events</option>
                  <option value="bounce_rate">Bounce Rate (%)</option>
                  <option value="session_duration">Avg Session Duration (s)</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Target</label>
                <input type="number" class="form-control" id="new-goal-target" placeholder="10000" min="1">
              </div>
              <div class="col-md-4">
                <label class="form-label">Period</label>
                <select class="form-select" id="new-goal-period">
                  <option value="daily">Daily</option>
                  <option value="weekly">Weekly</option>
                  <option value="monthly" selected>Monthly</option>
                  <option value="quarterly">Quarterly</option>
                  <option value="yearly">Yearly</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Comparison</label>
                <select class="form-select" id="new-goal-comparison">
                  <option value="gte">At Least (>=)</option>
                  <option value="lte">At Most (<=)</option>
                </select>
              </div>
              <div class="col-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="new-goal-notify" checked>
                  <label class="form-check-label" for="new-goal-notify">Notify me when goal is reached</label>
                </div>
              </div>
            </div>
            <button class="btn btn-primary mt-3" onclick="createGoal()">
              <i class="bi bi-plus-lg me-1"></i>Create Goal
            </button>
          </div>
        </div>

        <!-- Active Goals -->
        <h6 class="text-muted mb-3"><i class="bi bi-bar-chart me-2"></i>Your Goals</h6>
        <div id="goals-loading" class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <span class="ms-2">Loading goals...</span>
        </div>

        <div id="goals-list" class="d-none">
          <!-- Goals populated by JS -->
        </div>

        <div id="goals-empty" class="d-none text-center py-4 text-muted">
          <i class="bi bi-bullseye" style="font-size: 2rem;"></i>
          <p class="mt-2">No goals set yet</p>
          <p class="small">Create your first goal above to start tracking progress</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Funnels Modal -->
<div class="modal fade" id="funnelsModal" tabindex="-1" aria-labelledby="funnelsModalTitle">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="funnelsModalTitle">
          <i class="bi bi-funnel me-2"></i>Conversion Funnels
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Track user journeys through your site and identify where visitors drop off.</p>

        <!-- No Site Selected Warning -->
        <div id="funnels-no-site" class="alert alert-info d-none">
          <i class="bi bi-info-circle me-2"></i>Please select a site first to manage funnels.
        </div>

        <!-- Create New Funnel -->
        <div class="card mb-4" id="funnel-create-section">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Create New Funnel</h6>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#funnelCreateForm">
              <i class="bi bi-chevron-down"></i>
            </button>
          </div>
          <div class="collapse" id="funnelCreateForm">
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label">Funnel Name</label>
                <input type="text" class="form-control" id="new-funnel-name" placeholder="e.g., Checkout Flow">
              </div>

              <label class="form-label">Funnel Steps <span class="text-muted small">(minimum 2)</span></label>
              <div id="funnel-steps-container">
                <div class="funnel-step mb-2">
                  <div class="row g-2">
                    <div class="col-md-3">
                      <input type="text" class="form-control form-control-sm" placeholder="Step name" data-field="name">
                    </div>
                    <div class="col-md-2">
                      <select class="form-select form-select-sm" data-field="type">
                        <option value="page">Page</option>
                        <option value="event">Event</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <select class="form-select form-select-sm" data-field="operator">
                        <option value="equals">Equals</option>
                        <option value="contains">Contains</option>
                        <option value="starts_with">Starts with</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <input type="text" class="form-control form-control-sm" placeholder="e.g., /home or signup:click" data-field="value">
                    </div>
                    <div class="col-md-1">
                      <button class="btn btn-sm btn-outline-danger" onclick="removeFunnelStep(this)" disabled>
                        <i class="bi bi-x"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="funnel-step mb-2">
                  <div class="row g-2">
                    <div class="col-md-3">
                      <input type="text" class="form-control form-control-sm" placeholder="Step name" data-field="name">
                    </div>
                    <div class="col-md-2">
                      <select class="form-select form-select-sm" data-field="type">
                        <option value="page">Page</option>
                        <option value="event">Event</option>
                      </select>
                    </div>
                    <div class="col-md-2">
                      <select class="form-select form-select-sm" data-field="operator">
                        <option value="equals">Equals</option>
                        <option value="contains">Contains</option>
                        <option value="starts_with">Starts with</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <input type="text" class="form-control form-control-sm" placeholder="e.g., /checkout" data-field="value">
                    </div>
                    <div class="col-md-1">
                      <button class="btn btn-sm btn-outline-danger" onclick="removeFunnelStep(this)" disabled>
                        <i class="bi bi-x"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div class="d-flex gap-2 mb-3">
                <button class="btn btn-outline-secondary btn-sm" onclick="addFunnelStep()">
                  <i class="bi bi-plus me-1"></i>Add Step
                </button>
              </div>

              <button class="btn btn-primary" onclick="createFunnel()">
                <i class="bi bi-plus-lg me-1"></i>Create Funnel
              </button>
            </div>
          </div>
        </div>

        <!-- Existing Funnels -->
        <h6 class="text-muted mb-3"><i class="bi bi-bar-chart me-2"></i>Your Funnels</h6>
        <div id="funnels-loading" class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <span class="ms-2">Loading funnels...</span>
        </div>

        <div id="funnels-list" class="d-none">
          <!-- Funnels populated by JS -->
        </div>

        <div id="funnels-empty" class="d-none text-center py-4 text-muted">
          <i class="bi bi-funnel" style="font-size: 2rem;"></i>
          <p class="mt-2">No funnels created yet</p>
          <p class="small">Create your first funnel to start tracking conversions</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Heatmaps Modal -->
<div class="modal fade" id="heatmapsModal" tabindex="-1" aria-labelledby="heatmapsModalTitle">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="heatmapsModalTitle">
          <i class="bi bi-fire me-2"></i>Heatmaps
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Visualize where users click and how far they scroll on your pages.</p>

        <!-- No Site Selected Warning -->
        <div id="heatmaps-no-site" class="alert alert-info d-none">
          <i class="bi bi-info-circle me-2"></i>Please select a site first to view heatmaps.
        </div>

        <!-- Heatmap Controls -->
        <div class="card mb-4" id="heatmap-controls">
          <div class="card-body">
            <div class="row g-3 align-items-end">
              <div class="col-md-5">
                <label class="form-label">Select Page</label>
                <select class="form-select" id="heatmap-page-select" onchange="loadHeatmapData()">
                  <option value="">Loading pages...</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">View Type</label>
                <select class="form-select" id="heatmap-view-type" onchange="loadHeatmapData()">
                  <option value="clicks">Click Heatmap</option>
                  <option value="scroll">Scroll Depth</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Date Range</label>
                <div class="input-group">
                  <input type="date" class="form-control form-control-sm" id="heatmap-start-date">
                  <span class="input-group-text">to</span>
                  <input type="date" class="form-control form-control-sm" id="heatmap-end-date">
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Loading State -->
        <div id="heatmap-loading" class="text-center py-5 d-none">
          <div class="spinner-border text-primary"></div>
          <p class="mt-2 text-muted">Loading heatmap data...</p>
        </div>

        <!-- Click Heatmap View -->
        <div id="heatmap-clicks-view" class="d-none">
          <div class="row">
            <div class="col-md-8">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <span><i class="bi bi-cursor me-2"></i>Click Density</span>
                  <span class="badge bg-primary" id="heatmap-total-clicks">0 clicks</span>
                </div>
                <div class="card-body p-0">
                  <div id="heatmap-canvas-container" style="position: relative; background: #f8f9fa; min-height: 400px;">
                    <canvas id="heatmap-canvas" width="800" height="600" style="width: 100%; max-width: 800px; display: block; margin: 0 auto;"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card">
                <div class="card-header"><i class="bi bi-display me-2"></i>Viewport Distribution</div>
                <div class="card-body">
                  <div id="heatmap-viewport-stats">
                    <p class="text-muted small">Shows which screen sizes your visitors use</p>
                    <div id="heatmap-viewports-list">
                      <!-- Populated by JS -->
                    </div>
                  </div>
                </div>
              </div>
              <div class="card mt-3">
                <div class="card-header"><i class="bi bi-palette me-2"></i>Legend</div>
                <div class="card-body">
                  <div class="d-flex align-items-center mb-2">
                    <div style="width: 24px; height: 24px; background: linear-gradient(to right, blue, cyan, lime, yellow, red); border-radius: 4px;"></div>
                    <span class="ms-2 small">Low to High Click Density</span>
                  </div>
                  <p class="text-muted small mb-0">Warmer colors indicate more clicks in that area.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Scroll Depth View -->
        <div id="heatmap-scroll-view" class="d-none">
          <div class="row">
            <div class="col-md-8">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <span><i class="bi bi-arrow-down-circle me-2"></i>Scroll Reach</span>
                  <span class="badge bg-primary" id="heatmap-total-sessions">0 sessions</span>
                </div>
                <div class="card-body">
                  <div id="scroll-depth-chart" style="min-height: 300px;">
                    <!-- Scroll depth bars populated by JS -->
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card">
                <div class="card-header"><i class="bi bi-bar-chart me-2"></i>Key Metrics</div>
                <div class="card-body">
                  <div class="mb-3">
                    <div class="text-muted small">Average Max Scroll</div>
                    <div class="h4 mb-0" id="heatmap-avg-scroll">--%</div>
                  </div>
                  <div class="mb-3">
                    <div class="text-muted small">Reached 25%</div>
                    <div class="h5 mb-0" id="heatmap-reach-25">--%</div>
                  </div>
                  <div class="mb-3">
                    <div class="text-muted small">Reached 50%</div>
                    <div class="h5 mb-0" id="heatmap-reach-50">--%</div>
                  </div>
                  <div class="mb-3">
                    <div class="text-muted small">Reached 75%</div>
                    <div class="h5 mb-0" id="heatmap-reach-75">--%</div>
                  </div>
                  <div>
                    <div class="text-muted small">Reached 100%</div>
                    <div class="h5 mb-0" id="heatmap-reach-100">--%</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- No Data State -->
        <div id="heatmap-no-data" class="d-none text-center py-5 text-muted">
          <i class="bi bi-fire" style="font-size: 3rem;"></i>
          <h5 class="mt-3">No heatmap data yet</h5>
          <p>Heatmap data will appear here once visitors interact with your site.</p>
          <p class="small">Make sure the tracking script is installed and includes heatmap tracking.</p>
        </div>

        <!-- No Pages State -->
        <div id="heatmap-no-pages" class="d-none text-center py-5 text-muted">
          <i class="bi bi-file-earmark" style="font-size: 3rem;"></i>
          <h5 class="mt-3">No pages with heatmap data</h5>
          <p>No pages have recorded heatmap data in the selected date range.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Alerts Modal -->
<div class="modal fade" id="alertsModal" tabindex="-1" aria-labelledby="alertsModalTitle">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="alertsModalTitle">
          <i class="bi bi-bell me-2"></i>Traffic Alerts
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Get notified when your traffic spikes or drops significantly.</p>

        <!-- No Site Selected Warning -->
        <div id="alerts-no-site" class="alert alert-info d-none">
          <i class="bi bi-info-circle me-2"></i>Please select a site first to configure alerts.
        </div>

        <!-- Traffic Baseline -->
        <div id="alerts-baseline" class="alert alert-light mb-4 d-none">
          <h6 class="alert-heading"><i class="bi bi-graph-up me-2"></i>Your Traffic Baseline</h6>
          <div class="row text-center mt-3">
            <div class="col-4">
              <div class="h4 mb-0" id="baseline-hourly">-</div>
              <small class="text-muted">Avg. Hourly</small>
            </div>
            <div class="col-4">
              <div class="h4 mb-0" id="baseline-daily">-</div>
              <small class="text-muted">Avg. Daily</small>
            </div>
            <div class="col-4">
              <div class="h4 mb-0" id="baseline-days">-</div>
              <small class="text-muted">Days of Data</small>
            </div>
          </div>
        </div>

        <!-- Create New Alert -->
        <div class="card mb-4" id="alert-create-section">
          <div class="card-header">
            <h6 class="mb-0">Create Traffic Alert</h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Alert Name</label>
                <input type="text" class="form-control" id="new-alert-name" placeholder="e.g., Traffic Spike Alert">
              </div>
              <div class="col-md-6">
                <label class="form-label">Alert Type</label>
                <select class="form-select" id="new-alert-type">
                  <option value="traffic_spike">Traffic Spike (above baseline)</option>
                  <option value="low_traffic">Low Traffic (below baseline)</option>
                </select>
              </div>
            </div>
            <div class="row g-3 mt-2">
              <div class="col-md-4">
                <label class="form-label">Threshold</label>
                <div class="input-group">
                  <input type="number" class="form-control" id="new-alert-threshold" value="200" min="50" max="1000">
                  <span class="input-group-text">%</span>
                </div>
                <small class="text-muted">e.g., 200% = 2x normal traffic</small>
              </div>
              <div class="col-md-4">
                <label class="form-label">Time Window</label>
                <div class="input-group">
                  <input type="number" class="form-control" id="new-alert-window" value="60" min="15" max="1440">
                  <span class="input-group-text">min</span>
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Cooldown</label>
                <div class="input-group">
                  <input type="number" class="form-control" id="new-alert-cooldown" value="60" min="15" max="1440">
                  <span class="input-group-text">min</span>
                </div>
              </div>
            </div>
            <div class="mt-3">
              <label class="form-label">Notifications</label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="new-alert-email" checked>
                <label class="form-check-label" for="new-alert-email">Email notification</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="new-alert-webhook">
                <label class="form-check-label" for="new-alert-webhook">Send to configured webhooks</label>
              </div>
            </div>
            <button class="btn btn-primary mt-3" onclick="createAlert()">
              <i class="bi bi-plus-lg me-1"></i>Create Alert
            </button>
          </div>
        </div>

        <!-- Existing Alerts -->
        <h6 class="text-muted mb-3">Your Alerts</h6>
        <div id="alerts-loading" class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <span class="ms-2">Loading alerts...</span>
        </div>

        <div id="alerts-list" class="d-none">
          <!-- Alerts populated by JS -->
        </div>

        <div id="alerts-empty" class="d-none text-center py-4 text-muted">
          <i class="bi bi-bell" style="font-size: 2rem;"></i>
          <p class="mt-2">No alerts configured</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Webhooks Modal -->
<div class="modal fade" id="webhooksModal" tabindex="-1" aria-labelledby="webhooksModalTitle">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="webhooksModalTitle">
          <i class="bi bi-lightning me-2"></i>Webhooks
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Receive real-time notifications when events occur on your site.</p>

        <!-- No Site Selected Warning -->
        <div id="webhooks-no-site" class="alert alert-info d-none">
          <i class="bi bi-info-circle me-2"></i>Please select a site first to manage webhooks.
        </div>

        <!-- Create New Webhook -->
        <div class="card mb-4" id="webhook-create-section">
          <div class="card-header">
            <h6 class="mb-0">Create New Webhook</h6>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">Webhook Name</label>
              <input type="text" class="form-control" id="new-webhook-name" placeholder="e.g., Slack Notifications">
            </div>
            <div class="mb-3">
              <label class="form-label">Endpoint URL <span class="text-muted">(HTTPS required)</span></label>
              <input type="url" class="form-control" id="new-webhook-url" placeholder="https://your-server.com/webhook">
            </div>
            <div class="mb-3">
              <label class="form-label">Events to receive</label>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="event" id="webhook-event-event" checked>
                <label class="form-check-label" for="webhook-event-event">Custom Events</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="pageview" id="webhook-event-pageview">
                <label class="form-check-label" for="webhook-event-pageview">Pageviews <span class="text-muted small">(high volume)</span></label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="daily_summary" id="webhook-event-daily">
                <label class="form-check-label" for="webhook-event-daily">Daily Summary</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="traffic_spike" id="webhook-event-spike">
                <label class="form-check-label" for="webhook-event-spike">Traffic Spikes</label>
              </div>
            </div>
            <button class="btn btn-primary" onclick="createWebhook()">
              <i class="bi bi-plus-lg me-1"></i>Create Webhook
            </button>
          </div>
        </div>

        <!-- New Webhook Secret Display -->
        <div class="alert alert-success d-none" id="new-webhook-display">
          <h6 class="alert-heading"><i class="bi bi-check-circle me-2"></i>Webhook Created!</h6>
          <p class="mb-2">Copy the signing secret now. You won't be able to see it again.</p>
          <div class="input-group mb-2">
            <input type="text" class="form-control font-monospace" id="new-webhook-secret" readonly>
            <button class="btn btn-outline-secondary" onclick="copyWebhookSecret()">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>
          <small class="text-muted">Use this secret to verify webhook signatures.</small>
        </div>

        <!-- Existing Webhooks -->
        <h6 class="text-muted mb-3">Your Webhooks</h6>
        <div id="webhooks-loading" class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <span class="ms-2">Loading webhooks...</span>
        </div>

        <div id="webhooks-list" class="d-none">
          <!-- Webhooks populated by JS -->
        </div>

        <div id="webhooks-empty" class="d-none text-center py-4 text-muted">
          <i class="bi bi-lightning" style="font-size: 2rem;"></i>
          <p class="mt-2">No webhooks configured</p>
        </div>

        <!-- Webhook Documentation -->
        <div class="card mt-4">
          <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-book me-2"></i>Webhook Payload</h6>
          </div>
          <div class="card-body">
            <p class="small text-muted mb-2">Webhooks are sent as POST requests with JSON payloads:</p>
            <pre class="bg-light p-2 rounded small mb-2"><code>{
  "event": "event",
  "timestamp": "2024-01-15T10:30:00Z",
  "site_id": "site_xxx",
  "data": { ... }
}</code></pre>
            <p class="small text-muted mb-0">
              Verify the <code>X-ZTA-Signature</code> header using HMAC-SHA256 with your signing secret.
            </p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Activity Log Modal -->
<div class="modal fade" id="activityModal" tabindex="-1" aria-labelledby="activityModalTitle">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="activityModalTitle">
          <i class="bi bi-clock-history me-2"></i>Activity Log
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Recent account activity and security events.</p>

        <div id="activity-loading" class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <span class="ms-2">Loading activity...</span>
        </div>

        <div id="activity-list" class="d-none">
          <!-- Activities populated by JS -->
        </div>

        <div id="activity-empty" class="d-none text-center py-4 text-muted">
          <i class="bi bi-clock-history" style="font-size: 2rem;"></i>
          <p class="mt-2">No activity yet</p>
        </div>

        <div id="activity-load-more" class="text-center mt-3 d-none">
          <button class="btn btn-outline-secondary btn-sm" onclick="loadMoreActivity()">
            Load More
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- API Keys Modal -->
<div class="modal fade" id="apiKeysModal" tabindex="-1" aria-labelledby="apiKeysModalTitle">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="apiKeysModalTitle">
          <i class="bi bi-key me-2"></i>API Keys
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">API keys allow programmatic access to your analytics data.</p>

        <!-- Create New Key -->
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="mb-0">Create New API Key</h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Key Name</label>
                <input type="text" class="form-control" id="new-key-name" placeholder="e.g., Production App">
              </div>
              <div class="col-md-6">
                <label class="form-label">Permissions</label>
                <select class="form-select" id="new-key-permissions">
                  <option value="read">Read Only</option>
                  <option value="read,write">Read & Write</option>
                </select>
              </div>
            </div>
            <button class="btn btn-primary mt-3" onclick="createApiKey()">
              <i class="bi bi-plus-lg me-1"></i>Generate API Key
            </button>
          </div>
        </div>

        <!-- New Key Display (hidden by default) -->
        <div class="alert alert-success d-none" id="new-key-display">
          <h6 class="alert-heading"><i class="bi bi-check-circle me-2"></i>API Key Created!</h6>
          <p class="mb-2">Copy this key now. You won't be able to see it again.</p>
          <div class="input-group mb-2">
            <input type="text" class="form-control font-monospace" id="new-key-value" readonly>
            <button class="btn btn-outline-secondary" onclick="copyNewApiKey()">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>
          <small class="text-muted">Make sure to store this key securely.</small>
        </div>

        <!-- Existing Keys -->
        <h6 class="text-muted mb-3">Your API Keys</h6>
        <div id="api-keys-loading" class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <span class="ms-2">Loading keys...</span>
        </div>

        <div id="api-keys-list" class="d-none">
          <!-- Keys populated by JS -->
        </div>

        <div id="api-keys-empty" class="d-none text-center py-4 text-muted">
          <i class="bi bi-key" style="font-size: 2rem;"></i>
          <p class="mt-2">No API keys yet</p>
        </div>

        <!-- API Documentation -->
        <div class="card mt-4">
          <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-book me-2"></i>Quick Start</h6>
          </div>
          <div class="card-body">
            <p class="small text-muted mb-2">Use your API key in the Authorization header:</p>
            <pre class="bg-light p-2 rounded small mb-2"><code>curl -H "Authorization: Bearer YOUR_API_KEY" \
  https://ztas.io/api/stats?siteId=YOUR_SITE_ID&period=7d</code></pre>
            <p class="small text-muted mb-0">
              <a href="/docs/api/" target="_blank">View full API documentation</a>
            </p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Sessions Modal -->
<div class="modal fade" id="sessionsModal" tabindex="-1" aria-labelledby="sessionsModalTitle">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="sessionsModalTitle">
          <i class="bi bi-shield-check me-2"></i>Active Sessions
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-3">Manage devices and browsers where you're currently logged in.</p>

        <div id="sessions-loading" class="text-center py-4">
          <div class="spinner-border spinner-border-sm text-primary"></div>
          <span class="ms-2">Loading sessions...</span>
        </div>

        <div id="sessions-list" class="d-none">
          <!-- Sessions populated by JS -->
        </div>

        <div id="sessions-empty" class="d-none text-center py-4 text-muted">
          <i class="bi bi-shield-x" style="font-size: 2rem;"></i>
          <p class="mt-2">No active sessions found</p>
        </div>
      </div>
      <div class="modal-footer justify-content-between">
        <button type="button" class="btn btn-outline-danger" onclick="revokeAllSessions()">
          <i class="bi bi-box-arrow-right me-1"></i>Sign Out All Other Devices
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Site Modal -->
<!-- Share Dashboard Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalTitle">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="shareModalTitle">
          <i class="bi bi-share me-2"></i>Share Dashboard
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Create New Share -->
        <div id="share-create-section">
          <p class="text-muted mb-3">Create a public link to share your analytics dashboard with others.</p>

          <div class="mb-3">
            <label class="form-label">Link Expiration</label>
            <select class="form-select" id="share-expiry">
              <option value="">Never expires</option>
              <option value="1d">1 day</option>
              <option value="7d">7 days</option>
              <option value="30d">30 days</option>
              <option value="90d">90 days</option>
            </select>
          </div>

          <button class="btn btn-primary w-100" onclick="createShareLink()">
            <i class="bi bi-link-45deg me-1"></i>Generate Share Link
          </button>
        </div>

        <!-- Share Link Result -->
        <div id="share-result-section" class="d-none">
          <div class="alert alert-success">
            <i class="bi bi-check-circle me-2"></i>Share link created!
          </div>

          <div class="input-group mb-3">
            <input type="text" class="form-control" id="share-url" readonly>
            <button class="btn btn-outline-primary" onclick="copyShareLink()">
              <i class="bi bi-clipboard"></i>
            </button>
          </div>

          <button class="btn btn-outline-secondary w-100" onclick="showCreateShare()">
            <i class="bi bi-plus me-1"></i>Create Another Link
          </button>
        </div>

        <!-- Existing Shares -->
        <div id="existing-shares-section" class="mt-4 pt-3 border-top">
          <h6 class="text-muted mb-3">Active Share Links</h6>
          <div id="shares-list">
            <p class="text-muted small">Loading...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="addSiteModal" tabindex="-1" aria-labelledby="addSiteModalTitle" aria-describedby="addSiteModalDesc">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="addSiteModalTitle">Add New Site</h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close dialog"></button>
      </div>
      <div class="modal-body">
        <p id="addSiteModalDesc" class="visually-hidden">Add a new website to track with Zero Trust Analytics</p>
        <form id="add-site-form" onsubmit="handleAddSite(event)" novalidate>
          <div class="mb-3">
            <label for="site-domain" class="form-label">Website Domain</label>
            <input
              type="text"
              class="form-control"
              id="site-domain"
              placeholder="example.com"
              required
              aria-required="true"
              aria-describedby="site-domain-hint"
            >
            <div id="site-domain-hint" class="form-text">Enter your domain without https://</div>
          </div>
          <div class="alert alert-danger d-none" id="add-site-error" role="alert" aria-live="polite"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="add-site-form" class="btn btn-primary">Add Site</button>
      </div>
    </div>
  </div>
</div>

<!-- Site Settings Modal -->
<div class="modal fade" id="siteSettingsModal" tabindex="-1" aria-labelledby="siteSettingsModalTitle">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="siteSettingsModalTitle">Site Settings</h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close dialog"></button>
      </div>
      <div class="modal-body">
        <form id="site-settings-form" onsubmit="handleUpdateSite(event)" novalidate>
          <div class="mb-3">
            <label for="settings-site-id" class="form-label">Site ID</label>
            <input type="text" class="form-control" id="settings-site-id" readonly aria-readonly="true">
          </div>
          <div class="mb-3">
            <label for="settings-nickname" class="form-label">Nickname (optional)</label>
            <input
              type="text"
              class="form-control"
              id="settings-nickname"
              placeholder="My Website"
              aria-describedby="nickname-hint"
            >
            <div id="nickname-hint" class="form-text">A friendly name for this site</div>
          </div>
          <div class="mb-3">
            <label for="settings-domain" class="form-label">Domain</label>
            <input
              type="text"
              class="form-control"
              id="settings-domain"
              placeholder="example.com"
              required
              aria-required="true"
            >
          </div>
          <div class="alert alert-danger d-none" id="site-settings-error" role="alert" aria-live="polite"></div>
        </form>
        <hr>
        <div class="text-muted small mb-2" id="danger-zone-label">Danger Zone</div>
        <button
          class="btn btn-outline-danger w-100"
          onclick="confirmDeleteSite()"
          aria-describedby="danger-zone-label"
        >
          <i class="fas fa-trash me-2" aria-hidden="true"></i>Delete This Site
        </button>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="site-settings-form" class="btn btn-primary">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Import Google Analytics Data Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalTitle">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="importModalTitle">
          <i class="fas fa-upload me-2" aria-hidden="true"></i>Import Google Analytics Data
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- No Site Selected Warning -->
        <div id="import-no-site" class="alert alert-info d-none">
          <i class="fas fa-info-circle me-2" aria-hidden="true"></i>
          Please select a site first to import data.
        </div>

        <!-- Import Instructions -->
        <div id="import-instructions">
          <div class="alert alert-success mb-4">
            <h6 class="alert-heading mb-2"><i class="fas fa-lightbulb me-2"></i>Seamless Migration</h6>
            <p class="mb-0 small">Import your historical Google Analytics data to maintain continuity. Your dashboard will show GA data before the switch and ZTA data after.</p>
          </div>

          <h6 class="mb-3">How to Export from Google Analytics:</h6>

          <div class="accordion mb-4" id="importAccordion">
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGA4">
                  <i class="fab fa-google me-2"></i>Google Analytics 4 (GA4)
                </button>
              </h2>
              <div id="collapseGA4" class="accordion-collapse collapse show" data-bs-parent="#importAccordion">
                <div class="accordion-body small">
                  <ol class="mb-0">
                    <li>Go to <strong>Reports ‚Üí Acquisition ‚Üí Traffic acquisition</strong></li>
                    <li>Set your desired date range</li>
                    <li>Click the <strong>Share</strong> icon (top right)</li>
                    <li>Select <strong>Download file ‚Üí CSV</strong></li>
                    <li>Upload the downloaded file below</li>
                  </ol>
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUA">
                  <i class="fab fa-google me-2"></i>Universal Analytics (Legacy)
                </button>
              </h2>
              <div id="collapseUA" class="accordion-collapse collapse" data-bs-parent="#importAccordion">
                <div class="accordion-body small">
                  <ol class="mb-0">
                    <li>Go to <strong>Behavior ‚Üí Site Content ‚Üí All Pages</strong></li>
                    <li>Set your desired date range</li>
                    <li>Click <strong>Export ‚Üí CSV</strong></li>
                    <li>Upload the downloaded file below</li>
                  </ol>
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAPI">
                  <i class="fas fa-code me-2"></i>GA4 API / BigQuery
                </button>
              </h2>
              <div id="collapseAPI" class="accordion-collapse collapse" data-bs-parent="#importAccordion">
                <div class="accordion-body small">
                  <p>For large datasets, export via the GA4 API or BigQuery:</p>
                  <pre class="bg-light p-2 rounded small mb-0"><code>{
  "rows": [...],
  "dimensionHeaders": [{"name": "date"}, ...],
  "metricHeaders": [{"name": "screenPageViews"}, ...]
}</code></pre>
                </div>
              </div>
            </div>
          </div>

          <!-- File Upload -->
          <div class="mb-4">
            <label for="import-file" class="form-label">Upload Export File</label>
            <input type="file" class="form-control" id="import-file" accept=".csv,.json,.txt" onchange="handleImportFileSelect(event)">
            <div class="form-text">Supported formats: CSV, JSON (max 10MB)</div>
          </div>

          <!-- Or Paste JSON -->
          <div class="mb-4">
            <label for="import-json" class="form-label">Or Paste JSON Data</label>
            <textarea class="form-control font-monospace small" id="import-json" rows="4" placeholder='[{"date":"20241201","pageviews":150,"sessions":100}, ...]'></textarea>
          </div>

          <!-- Format Selection -->
          <div class="mb-4">
            <label for="import-format" class="form-label">Data Format</label>
            <select class="form-select" id="import-format">
              <option value="csv">CSV (GA4 or Universal Analytics export)</option>
              <option value="json">JSON (API response or custom)</option>
              <option value="ga4-api">GA4 API Response Format</option>
              <option value="ua-csv">Universal Analytics CSV</option>
            </select>
          </div>

          <!-- Preview -->
          <div id="import-preview" class="d-none mb-4">
            <h6 class="mb-2">Preview (first 5 rows):</h6>
            <div class="table-responsive">
              <table class="table table-sm table-bordered small" id="import-preview-table">
                <thead class="table-light"></thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="text-muted small" id="import-preview-count"></div>
          </div>

          <!-- Error Display -->
          <div id="import-error" class="alert alert-danger d-none" role="alert"></div>

          <!-- Success Display -->
          <div id="import-success" class="alert alert-success d-none" role="alert"></div>
        </div>

        <!-- Import History -->
        <div id="import-history-section" class="mt-4 pt-3 border-top">
          <h6 class="text-muted mb-3">Import History</h6>
          <div id="import-history-list">
            <p class="text-muted small">No previous imports.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="import-submit-btn" onclick="submitImport()" disabled>
          <i class="fas fa-upload me-1" aria-hidden="true"></i>Import Data
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Google Search Console Modal -->
<div class="modal fade" id="gscModal" tabindex="-1" aria-labelledby="gscModalTitle">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title h5" id="gscModalTitle">
          <i class="fab fa-google me-2" aria-hidden="true"></i>Google Search Console
        </h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Connection Status -->
        <div id="gsc-not-connected">
          <div class="text-center py-5">
            <i class="fab fa-google fa-4x text-muted mb-4"></i>
            <h4>Connect Google Search Console</h4>
            <p class="text-muted mb-4">View your search performance data alongside your analytics.<br>See impressions, clicks, CTR, and keyword rankings.</p>
            <button class="btn btn-primary btn-lg" onclick="connectGSC()">
              <i class="fab fa-google me-2"></i>Connect Google Search Console
            </button>
            <p class="text-muted small mt-3">We only request read-only access to your search data.</p>
          </div>
        </div>

        <!-- Connected View -->
        <div id="gsc-connected" class="d-none">
          <!-- GSC Site Selector -->
          <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
            <div class="d-flex align-items-center gap-3">
              <label for="gsc-site-selector" class="form-label mb-0">GSC Property:</label>
              <select class="form-select form-select-sm" id="gsc-site-selector" onchange="loadGSCData()" style="min-width: 300px;">
                <option value="">Select a property...</option>
              </select>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary btn-sm" onclick="refreshGSCData()">
                <i class="fas fa-sync-alt me-1"></i>Refresh
              </button>
              <button class="btn btn-outline-danger btn-sm" onclick="disconnectGSC()">
                <i class="fas fa-unlink me-1"></i>Disconnect
              </button>
            </div>
          </div>

          <!-- GSC Metrics Cards -->
          <div class="row g-3 mb-4">
            <div class="col-md-3">
              <div class="card bg-primary text-white h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h6 class="card-subtitle mb-2 text-white-50">Total Clicks</h6>
                      <h3 class="card-title mb-0" id="gsc-total-clicks">-</h3>
                    </div>
                    <i class="fas fa-mouse-pointer fa-2x opacity-50"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-info text-white h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h6 class="card-subtitle mb-2 text-white-50">Total Impressions</h6>
                      <h3 class="card-title mb-0" id="gsc-total-impressions">-</h3>
                    </div>
                    <i class="fas fa-eye fa-2x opacity-50"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-success text-white h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h6 class="card-subtitle mb-2 text-white-50">Average CTR</h6>
                      <h3 class="card-title mb-0" id="gsc-avg-ctr">-</h3>
                    </div>
                    <i class="fas fa-percentage fa-2x opacity-50"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-warning text-dark h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h6 class="card-subtitle mb-2 text-dark-50">Avg Position</h6>
                      <h3 class="card-title mb-0" id="gsc-avg-position">-</h3>
                    </div>
                    <i class="fas fa-sort-numeric-up fa-2x opacity-50"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- GSC Tabs -->
          <ul class="nav nav-tabs" id="gscTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="gsc-queries-tab" data-bs-toggle="tab" data-bs-target="#gsc-queries" type="button" role="tab">
                <i class="fas fa-search me-1"></i>Top Queries
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="gsc-pages-tab" data-bs-toggle="tab" data-bs-target="#gsc-pages" type="button" role="tab">
                <i class="fas fa-file-alt me-1"></i>Top Pages
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="gsc-performance-tab" data-bs-toggle="tab" data-bs-target="#gsc-performance" type="button" role="tab">
                <i class="fas fa-chart-line me-1"></i>Performance Over Time
              </button>
            </li>
          </ul>
          <div class="tab-content border border-top-0 rounded-bottom p-3" id="gscTabContent">
            <!-- Top Queries Tab -->
            <div class="tab-pane fade show active" id="gsc-queries" role="tabpanel">
              <div class="table-responsive">
                <table class="table table-hover" id="gsc-queries-table">
                  <thead class="table-light">
                    <tr>
                      <th>Search Query</th>
                      <th class="text-end">Clicks</th>
                      <th class="text-end">Impressions</th>
                      <th class="text-end">CTR</th>
                      <th class="text-end">Position</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr><td colspan="5" class="text-center text-muted py-4">Select a property to view data</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <!-- Top Pages Tab -->
            <div class="tab-pane fade" id="gsc-pages" role="tabpanel">
              <div class="table-responsive">
                <table class="table table-hover" id="gsc-pages-table">
                  <thead class="table-light">
                    <tr>
                      <th>Page URL</th>
                      <th class="text-end">Clicks</th>
                      <th class="text-end">Impressions</th>
                      <th class="text-end">CTR</th>
                      <th class="text-end">Position</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr><td colspan="5" class="text-center text-muted py-4">Select a property to view data</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <!-- Performance Over Time Tab -->
            <div class="tab-pane fade" id="gsc-performance" role="tabpanel">
              <div id="gsc-chart-container" style="height: 300px;">
                <canvas id="gsc-performance-chart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Loading State -->
        <div id="gsc-loading" class="d-none text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3 text-muted">Loading Search Console data...</p>
        </div>

        <!-- Error State -->
        <div id="gsc-error" class="d-none">
          <div class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="gsc-error-message">An error occurred while fetching Search Console data.</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Onboarding Wizard Modal -->
<div class="modal fade" id="onboardingModal" tabindex="-1" aria-labelledby="onboardingModalTitle" data-bs-backdrop="static">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header border-0 pb-0">
        <h2 class="modal-title h4" id="onboardingModalTitle">Welcome to Zero Trust Analytics!</h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body pt-2">
        <!-- Progress Steps -->
        <div class="d-flex justify-content-center mb-4">
          <div class="onboarding-steps d-flex align-items-center">
            <div class="step active" id="step-1-indicator">
              <span class="step-number">1</span>
              <span class="step-label d-none d-sm-inline">Add Site</span>
            </div>
            <div class="step-line"></div>
            <div class="step" id="step-2-indicator">
              <span class="step-number">2</span>
              <span class="step-label d-none d-sm-inline">Install</span>
            </div>
            <div class="step-line"></div>
            <div class="step" id="step-3-indicator">
              <span class="step-number">3</span>
              <span class="step-label d-none d-sm-inline">Verify</span>
            </div>
          </div>
        </div>

        <!-- Step 1: Add Site -->
        <div class="onboarding-step" id="onboarding-step-1">
          <div class="text-center mb-4">
            <i class="fas fa-globe fa-3x text-primary mb-3"></i>
            <h4>Add your first website</h4>
            <p class="text-muted">Enter your website domain to start tracking privacy-friendly analytics.</p>
          </div>
          <div class="mx-auto" style="max-width: 400px;">
            <div class="mb-3">
              <label for="onboarding-domain" class="form-label">Website Domain</label>
              <input type="text" class="form-control form-control-lg" id="onboarding-domain" placeholder="example.com">
              <div class="form-text">Enter without https://</div>
            </div>
            <div class="alert alert-danger d-none" id="onboarding-error"></div>
          </div>
        </div>

        <!-- Step 2: Install Script -->
        <div class="onboarding-step d-none" id="onboarding-step-2">
          <div class="text-center mb-4">
            <i class="fas fa-code fa-3x text-primary mb-3"></i>
            <h4>Install the tracking script</h4>
            <p class="text-muted">Add this code to your website's <code>&lt;head&gt;</code> tag.</p>
          </div>
          <div class="mx-auto" style="max-width: 600px;">
            <div class="position-relative">
              <pre class="bg-dark text-light p-3 rounded" style="font-size: 0.85rem;"><code id="onboarding-embed-code">&lt;script src="https://ztas.io/js/analytics.js" data-site-id="YOUR_SITE_ID"&gt;&lt;/script&gt;</code></pre>
              <button class="btn btn-sm btn-outline-light position-absolute top-0 end-0 m-2" onclick="copyOnboardingCode()">
                <i class="fas fa-copy me-1"></i>Copy
              </button>
            </div>
            <div class="alert alert-info mt-3">
              <i class="fas fa-lightbulb me-2"></i>
              <strong>Tip:</strong> Place this script right before the closing <code>&lt;/head&gt;</code> tag for best performance.
            </div>
          </div>
        </div>

        <!-- Step 3: Verify -->
        <div class="onboarding-step d-none" id="onboarding-step-3">
          <div class="text-center mb-4" id="verify-waiting">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">Checking...</span>
            </div>
            <h4>Waiting for first pageview...</h4>
            <p class="text-muted">Visit your website in another tab. We'll detect it automatically.</p>
            <p class="small text-muted mt-3">
              <i class="fas fa-clock me-1"></i>Checking every 5 seconds...
              <span id="verify-attempts">(0 attempts)</span>
            </p>
          </div>
          <div class="text-center mb-4 d-none" id="verify-success">
            <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
            <h4 class="text-success">Success! We received your first pageview!</h4>
            <p class="text-muted">Your analytics are now being tracked. Welcome aboard!</p>
            <div class="confetti-container" id="confetti"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-outline-secondary" id="onboarding-back" onclick="onboardingBack()" style="display: none;">
          <i class="fas fa-arrow-left me-1"></i>Back
        </button>
        <button type="button" class="btn btn-primary" id="onboarding-next" onclick="onboardingNext()">
          Continue<i class="fas fa-arrow-right ms-1"></i>
        </button>
        <button type="button" class="btn btn-success d-none" id="onboarding-finish" data-bs-dismiss="modal" onclick="finishOnboarding()">
          Go to Dashboard<i class="fas fa-arrow-right ms-1"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<style>
/* Onboarding wizard styles */
.onboarding-steps {
  gap: 0.5rem;
}
.onboarding-steps .step {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: #6c757d;
}
.onboarding-steps .step.active {
  color: #0d6efd;
}
.onboarding-steps .step.completed {
  color: #198754;
}
.onboarding-steps .step-number {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #e9ecef;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
}
.onboarding-steps .step.active .step-number {
  background: #0d6efd;
  color: white;
}
.onboarding-steps .step.completed .step-number {
  background: #198754;
  color: white;
}
.onboarding-steps .step-line {
  width: 40px;
  height: 2px;
  background: #dee2e6;
}
@keyframes confetti-fall {
  0% { transform: translateY(-100%) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}
.confetti {
  position: fixed;
  width: 10px;
  height: 10px;
  top: 0;
  animation: confetti-fall 3s ease-out forwards;
}

.pulse-dot {
  width: 8px;
  height: 8px;
  background: white;
  border-radius: 50%;
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 0.75rem;
}
.stats-grid-secondary {
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
}
.stat-card {
  padding: 1rem;
  background: white;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.stat-card .stat-value {
  font-size: 1.5rem;
  font-weight: 600;
  word-break: break-word;
}
.stat-card-sm .stat-value {
  font-size: 1.25rem;
}
.stat-card .stat-label {
  font-size: 0.75rem;
  color: #6c757d;
  text-transform: uppercase;
}
.stat-card .stat-comparison {
  font-size: 0.75rem;
  margin-top: 0.25rem;
}
.stat-comparison .up {
  color: #198754;
}
.stat-comparison .down {
  color: #dc3545;
}
.stat-comparison .neutral {
  color: #6c757d;
}
.data-table {
  background: white;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  overflow: hidden;
}
.data-table .table {
  margin-bottom: 0;
  table-layout: fixed;
}
.data-table .table td, .data-table .table th {
  padding: 0.5rem 0.75rem;
  font-size: 0.8rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.data-table .table td:first-child {
  max-width: 200px;
}
.embed-code {
  background: #f8f9fa;
  padding: 0.75rem;
  border-radius: 4px;
  overflow-x: auto;
  font-size: 0.8rem;
}
.embed-code code {
  white-space: pre-wrap;
  word-break: break-all;
}
/* Loading skeleton */
.skeleton {
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: skeleton-loading 1.5s infinite;
  border-radius: 4px;
}
@keyframes skeleton-loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
.skeleton-text { height: 1rem; margin-bottom: 0.5rem; }
.skeleton-title { height: 1.5rem; width: 60%; margin-bottom: 0.75rem; }
.skeleton-stat { height: 2rem; width: 80%; }
.skeleton-chart { height: 200px; width: 100%; }
.skeleton-row { height: 2.5rem; margin-bottom: 0.25rem; }

/* Tab navigation styles */
#dashboardTabs {
  border-bottom: 2px solid #dee2e6;
  flex-wrap: nowrap;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
#dashboardTabs .nav-link {
  border: none;
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
  color: #6c757d;
  white-space: nowrap;
  padding: 0.75rem 1rem;
}
#dashboardTabs .nav-link:hover {
  border-color: transparent;
  color: #0d6efd;
}
#dashboardTabs .nav-link.active {
  border-bottom-color: #0d6efd;
  color: #0d6efd;
  background: none;
}

/* Tablet fixes */
@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
  }
  .card-header h5 {
    font-size: 1rem;
  }
  #dashboardTabs .nav-link {
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
  }
}

/* Mobile fixes */
@media (max-width: 576px) {
  .dashboard-container {
    padding-top: 0.5rem;
  }
  .dashboard-container h1 {
    font-size: 1.5rem;
  }
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
  }
  .stats-grid-secondary {
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
  }
  .stat-card {
    padding: 0.75rem;
  }
  .stat-card .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
  }
  .stat-card .stat-label {
    font-size: 0.65rem;
  }
  .stat-card-sm .stat-value {
    font-size: 1.1rem;
  }
  .d-flex.gap-2 {
    flex-wrap: wrap;
  }
  /* Touch-friendly period selector */
  .period-selector {
    flex-wrap: nowrap;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 0.25rem;
  }
  .period-selector .btn {
    padding: 0.5rem 0.75rem;
    font-size: 0.8rem;
    white-space: nowrap;
    min-height: 44px;
  }
  /* Card-based tables on mobile */
  .data-table {
    margin-bottom: 1rem;
  }
  .data-table .table {
    display: block;
  }
  .data-table .table thead {
    display: none;
  }
  .data-table .table tbody {
    display: block;
  }
  .data-table .table tr {
    display: flex;
    flex-wrap: wrap;
    padding: 0.75rem;
    border-bottom: 1px solid #dee2e6;
    align-items: center;
  }
  .data-table .table td {
    border: none;
    padding: 0.25rem 0;
    font-size: 0.85rem;
  }
  .data-table .table td:first-child {
    flex: 1 1 70%;
    font-weight: 500;
    max-width: none;
  }
  .data-table .table td:last-child,
  .data-table .table td.text-end {
    flex: 0 0 auto;
    text-align: right;
    font-weight: 600;
    color: #0d6efd;
  }
  /* Hide date pickers on mobile - use period buttons */
  fieldset.d-flex {
    display: none !important;
  }
  /* Larger touch targets */
  .btn {
    min-height: 44px;
    min-width: 44px;
  }
  .btn-sm {
    min-height: 38px;
    padding: 0.5rem 0.75rem;
  }
  /* Site selector full width */
  .site-selector {
    width: 100%;
  }
  .site-selector .form-select {
    flex: 1;
  }
  /* Real-time badge */
  .bg-success.text-white {
    font-size: 0.9rem;
    padding: 0.5rem 0.75rem !important;
  }
  /* Charts responsive */
  .card-body canvas {
    max-height: 200px;
  }
  /* Export buttons stack */
  .d-flex.gap-2.flex-wrap {
    gap: 0.5rem !important;
  }
  .d-flex.gap-2.flex-wrap .btn {
    flex: 1 1 calc(50% - 0.25rem);
    font-size: 0.75rem;
  }
}

/* Print styles for PDF export */
@media print {
  /* Hide non-essential elements */
  header, footer, nav,
  .navbar, .trial-banner, .expired-banner,
  #site-settings-btn, #empty-state,
  .period-selector, .date-range-picker,
  .btn-group, .dropdown, .modal,
  #loading-skeleton,
  button:not(.print-include),
  .btn:not(.print-include) {
    display: none !important;
  }

  /* Reset colors for print */
  body, .card, .stat-card {
    background: white !important;
    color: black !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }

  /* Page setup */
  @page {
    size: A4 portrait;
    margin: 1.5cm;
  }

  /* Print header */
  .print-header {
    display: block !important;
    text-align: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #0d6efd;
  }

  .print-header h1 {
    font-size: 1.5rem;
    margin: 0;
  }

  .print-header .print-meta {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.25rem;
  }

  /* Cards layout */
  .stat-card {
    break-inside: avoid;
    border: 1px solid #ddd !important;
    box-shadow: none !important;
    margin-bottom: 0.5rem;
  }

  .card {
    break-inside: avoid;
    border: 1px solid #ddd !important;
    box-shadow: none !important;
    page-break-inside: avoid;
  }

  /* Tables */
  table {
    font-size: 0.85rem;
  }

  /* Charts - ensure they print */
  canvas {
    max-width: 100% !important;
    height: auto !important;
  }

  /* Show all tab content */
  .tab-pane {
    display: block !important;
    opacity: 1 !important;
  }

  .nav-tabs {
    display: none !important;
  }

  /* Grid adjustments */
  .row {
    display: flex !important;
    flex-wrap: wrap !important;
  }

  .col-md-3, .col-lg-3 {
    width: 25% !important;
    flex: 0 0 25% !important;
  }

  .col-md-6, .col-lg-6 {
    width: 50% !important;
    flex: 0 0 50% !important;
  }

  /* Footer */
  .print-footer {
    display: block !important;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    text-align: center;
    font-size: 0.75rem;
    color: #999;
    border-top: 1px solid #ddd;
    padding-top: 0.25rem;
  }
}

/* Hidden print elements (shown only when printing) */
.print-header, .print-footer {
  display: none;
}
</style>

<script>
// Load errors data
async function loadErrors() {
  const siteId = getCurrentSiteId(); // Assumes this function exists in the dashboard
  if (!siteId) return;

  try {
    const response = await fetch(`/api/errors?siteId=${siteId}&limit=50`, {
      headers: {
        'Authorization': `Bearer ${getAuthToken()}` // Assumes this function exists
      }
    });

    if (!response.ok) {
      console.error('Failed to load errors:', response.statusText);
      return;
    }

    const data = await response.json();
    renderErrorsTable(data.errors || []);
  } catch (err) {
    console.error('Error loading errors:', err);
  }
}

function renderErrorsTable(errors) {
  const tbody = document.getElementById('errors-table');
  const countBadge = document.getElementById('errors-count');

  if (!tbody) return;

  if (errors.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No errors tracked</td></tr>';
    if (countBadge) countBadge.textContent = '0';
    return;
  }

  if (countBadge) countBadge.textContent = errors.length;

  tbody.innerHTML = errors.map(error => {
    const lastSeen = new Date(error.last_seen);
    const relativeTime = formatRelativeTime(lastSeen);
    const referrerDisplay = error.referrer ? truncateUrl(error.referrer, 30) : '-';

    let typeClass = 'badge bg-warning';
    if (error.type === '404') typeClass = 'badge bg-danger';
    else if (error.type === 'js_error') typeClass = 'badge bg-warning';
    else if (error.type === '500') typeClass = 'badge bg-danger';

    return `
      <tr>
        <td><code class="text-break">${escapeHtml(error.url)}</code></td>
        <td><span class="${typeClass}">${escapeHtml(error.type)}</span></td>
        <td class="text-end"><strong>${error.count}</strong></td>
        <td class="text-muted small" title="${lastSeen.toLocaleString()}">${relativeTime}</td>
        <td class="text-muted small" title="${escapeHtml(error.referrer || '')}">${escapeHtml(referrerDisplay)}</td>
      </tr>
    `;
  }).join('');
}

function formatRelativeTime(date) {
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 30) return `${diffDays}d ago`;
  return date.toLocaleDateString();
}

function truncateUrl(url, maxLength) {
  if (!url || url.length <= maxLength) return url;
  return url.substring(0, maxLength) + '...';
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Hook into existing dashboard load cycle
if (typeof window.dashboardLoadCallbacks !== 'undefined') {
  window.dashboardLoadCallbacks = window.dashboardLoadCallbacks || [];
  window.dashboardLoadCallbacks.push(loadErrors);
} else {
  // Fallback: try to load after a short delay to ensure dashboard is initialized
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(loadErrors, 1000);
  });
}

// ============================================
// Google Analytics Import Functions
// ============================================

let importData = null;
let importFormat = 'csv';

function openImportModal() {
  const modal = new bootstrap.Modal(document.getElementById('importModal'));
  const siteId = getCurrentSiteId();

  // Reset state
  importData = null;
  document.getElementById('import-file').value = '';
  document.getElementById('import-json').value = '';
  document.getElementById('import-preview').classList.add('d-none');
  document.getElementById('import-error').classList.add('d-none');
  document.getElementById('import-success').classList.add('d-none');
  document.getElementById('import-submit-btn').disabled = true;

  // Show/hide no site warning
  if (!siteId) {
    document.getElementById('import-no-site').classList.remove('d-none');
    document.getElementById('import-instructions').style.opacity = '0.5';
    document.getElementById('import-instructions').style.pointerEvents = 'none';
  } else {
    document.getElementById('import-no-site').classList.add('d-none');
    document.getElementById('import-instructions').style.opacity = '1';
    document.getElementById('import-instructions').style.pointerEvents = 'auto';
  }

  // Load import history
  loadImportHistory();

  modal.show();
}

async function handleImportFileSelect(event) {
  const file = event.target.files[0];
  if (!file) return;

  // Check file size (10MB max)
  if (file.size > 10 * 1024 * 1024) {
    showImportError('File size exceeds 10MB limit');
    return;
  }

  try {
    const text = await file.text();

    // Auto-detect format
    if (file.name.endsWith('.json') || text.trim().startsWith('{') || text.trim().startsWith('[')) {
      document.getElementById('import-format').value = 'json';
      importFormat = 'json';
      try {
        importData = JSON.parse(text);
      } catch (e) {
        showImportError('Invalid JSON format');
        return;
      }
    } else {
      document.getElementById('import-format').value = 'csv';
      importFormat = 'csv';
      importData = text;
    }

    // Show preview
    showImportPreview();
    document.getElementById('import-submit-btn').disabled = false;

  } catch (err) {
    showImportError('Failed to read file: ' + err.message);
  }
}

function showImportPreview() {
  const previewEl = document.getElementById('import-preview');
  const tableEl = document.getElementById('import-preview-table');
  const countEl = document.getElementById('import-preview-count');

  let rows = [];
  let headers = [];

  try {
    if (importFormat === 'csv' && typeof importData === 'string') {
      const lines = importData.trim().split('\n');
      headers = parseCSVLine(lines[0]);
      rows = lines.slice(1, 6).map(line => parseCSVLine(line));
      countEl.textContent = `Showing ${rows.length} of ${lines.length - 1} rows`;
    } else if (Array.isArray(importData)) {
      headers = Object.keys(importData[0] || {});
      rows = importData.slice(0, 5).map(row => headers.map(h => row[h]));
      countEl.textContent = `Showing ${rows.length} of ${importData.length} rows`;
    } else if (importData.rows) {
      // GA4 API format
      headers = (importData.dimensionHeaders || []).map(h => h.name)
                .concat((importData.metricHeaders || []).map(h => h.name));
      rows = importData.rows.slice(0, 5).map(row =>
        (row.dimensionValues || []).map(v => v.value)
        .concat((row.metricValues || []).map(v => v.value))
      );
      countEl.textContent = `Showing ${rows.length} of ${importData.rows.length} rows`;
    }

    // Render table
    tableEl.querySelector('thead').innerHTML = '<tr>' + headers.map(h =>
      `<th>${escapeHtml(String(h))}</th>`
    ).join('') + '</tr>';

    tableEl.querySelector('tbody').innerHTML = rows.map(row =>
      '<tr>' + row.map(cell => `<td>${escapeHtml(String(cell || ''))}</td>`).join('') + '</tr>'
    ).join('');

    previewEl.classList.remove('d-none');
    document.getElementById('import-error').classList.add('d-none');

  } catch (err) {
    showImportError('Failed to parse data: ' + err.message);
  }
}

function parseCSVLine(line) {
  const values = [];
  let current = '';
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === ',' && !inQuotes) {
      values.push(current.trim());
      current = '';
    } else {
      current += char;
    }
  }
  values.push(current.trim());
  return values;
}

async function submitImport() {
  const siteId = getCurrentSiteId();
  if (!siteId) {
    showImportError('Please select a site first');
    return;
  }

  if (!importData) {
    showImportError('No data to import');
    return;
  }

  const format = document.getElementById('import-format').value;
  const submitBtn = document.getElementById('import-submit-btn');

  submitBtn.disabled = true;
  submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Importing...';

  try {
    const response = await fetch('/api/import', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${getAuthToken()}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        siteId: siteId,
        format: format,
        data: importData,
        source: 'google-analytics'
      })
    });

    const result = await response.json();

    if (!response.ok) {
      throw new Error(result.error || 'Import failed');
    }

    // Show success
    document.getElementById('import-error').classList.add('d-none');
    const successEl = document.getElementById('import-success');
    successEl.innerHTML = `
      <i class="fas fa-check-circle me-2"></i>
      <strong>Import successful!</strong><br>
      ${result.recordsStored} days of historical data imported.
      ${result.dateRange ? `<br><small>Date range: ${result.dateRange.start} to ${result.dateRange.end}</small>` : ''}
    `;
    successEl.classList.remove('d-none');

    // Reset form
    importData = null;
    document.getElementById('import-file').value = '';
    document.getElementById('import-json').value = '';
    document.getElementById('import-preview').classList.add('d-none');

    // Reload import history
    loadImportHistory();

    // Refresh dashboard data
    if (typeof loadStats === 'function') {
      setTimeout(loadStats, 500);
    }

  } catch (err) {
    showImportError(err.message);
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="fas fa-upload me-1"></i>Import Data';
  }
}

async function loadImportHistory() {
  const listEl = document.getElementById('import-history-list');

  try {
    const response = await fetch('/api/import', {
      headers: {
        'Authorization': `Bearer ${getAuthToken()}`
      }
    });

    if (!response.ok) {
      listEl.innerHTML = '<p class="text-muted small">Failed to load import history</p>';
      return;
    }

    const data = await response.json();
    const imports = data.imports || [];

    if (imports.length === 0) {
      listEl.innerHTML = '<p class="text-muted small">No previous imports.</p>';
      return;
    }

    listEl.innerHTML = imports.slice(0, 10).map(imp => {
      const date = new Date(imp.importedAt);
      return `
        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
          <div>
            <small class="text-muted">${date.toLocaleDateString()}</small>
            <span class="ms-2">${imp.recordCount} records</span>
            <span class="badge bg-secondary ms-2">${imp.source || 'GA'}</span>
          </div>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteImport('${imp.id}')" title="Delete import">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;
    }).join('');

  } catch (err) {
    listEl.innerHTML = '<p class="text-muted small">Failed to load import history</p>';
  }
}

async function deleteImport(importId) {
  if (!confirm('Are you sure you want to delete this import? All imported historical data will be removed.')) {
    return;
  }

  try {
    const response = await fetch(`/api/import?importId=${importId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${getAuthToken()}`
      }
    });

    if (!response.ok) {
      const data = await response.json();
      throw new Error(data.error || 'Delete failed');
    }

    // Reload history
    loadImportHistory();

    // Refresh dashboard
    if (typeof loadStats === 'function') {
      loadStats();
    }

  } catch (err) {
    alert('Failed to delete import: ' + err.message);
  }
}

function showImportError(message) {
  const errorEl = document.getElementById('import-error');
  errorEl.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i>' + escapeHtml(message);
  errorEl.classList.remove('d-none');
  document.getElementById('import-success').classList.add('d-none');
}

// Handle paste in JSON textarea
document.addEventListener('DOMContentLoaded', function() {
  const jsonTextarea = document.getElementById('import-json');
  if (jsonTextarea) {
    jsonTextarea.addEventListener('input', function() {
      const text = this.value.trim();
      if (text) {
        try {
          importData = JSON.parse(text);
          importFormat = 'json';
          document.getElementById('import-format').value = 'json';
          showImportPreview();
          document.getElementById('import-submit-btn').disabled = false;
        } catch (e) {
          // Invalid JSON, disable submit
          document.getElementById('import-submit-btn').disabled = true;
          document.getElementById('import-preview').classList.add('d-none');
        }
      } else {
        importData = null;
        document.getElementById('import-submit-btn').disabled = true;
        document.getElementById('import-preview').classList.add('d-none');
      }
    });
  }
});

// ============================================
// Google Search Console Functions
// ============================================

let gscChart = null;

function openGSCModal() {
  const modal = new bootstrap.Modal(document.getElementById('gscModal'));
  modal.show();
  checkGSCStatus();
}

async function checkGSCStatus() {
  showGSCLoading(true);

  try {
    const response = await fetch('/.netlify/functions/gsc?action=status', {
      headers: {
        'Authorization': `Bearer ${getAuthToken()}`
      }
    });

    const data = await response.json();

    if (data.connected) {
      document.getElementById('gsc-not-connected').classList.add('d-none');
      document.getElementById('gsc-connected').classList.remove('d-none');
      await loadGSCSites();
    } else {
      document.getElementById('gsc-not-connected').classList.remove('d-none');
      document.getElementById('gsc-connected').classList.add('d-none');
    }
  } catch (err) {
    showGSCError('Failed to check connection status: ' + err.message);
  } finally {
    showGSCLoading(false);
  }
}

async function connectGSC() {
  showGSCLoading(true);

  try {
    const response = await fetch('/.netlify/functions/gsc?action=connect', {
      headers: {
        'Authorization': `Bearer ${getAuthToken()}`
      }
    });

    const data = await response.json();

    if (data.authUrl) {
      // Redirect to Google OAuth
      window.location.href = data.authUrl;
    } else {
      showGSCError(data.error || 'Failed to start OAuth flow');
    }
  } catch (err) {
    showGSCError('Failed to connect: ' + err.message);
  } finally {
    showGSCLoading(false);
  }
}

async function disconnectGSC() {
  if (!confirm('Are you sure you want to disconnect Google Search Console?')) {
    return;
  }

  try {
    const response = await fetch('/.netlify/functions/gsc?action=disconnect', {
      headers: {
        'Authorization': `Bearer ${getAuthToken()}`
      }
    });

    if (response.ok) {
      document.getElementById('gsc-not-connected').classList.remove('d-none');
      document.getElementById('gsc-connected').classList.add('d-none');
    }
  } catch (err) {
    showGSCError('Failed to disconnect: ' + err.message);
  }
}

async function loadGSCSites() {
  try {
    const response = await fetch('/.netlify/functions/gsc?action=sites', {
      headers: {
        'Authorization': `Bearer ${getAuthToken()}`
      }
    });

    const data = await response.json();
    const selector = document.getElementById('gsc-site-selector');

    selector.innerHTML = '<option value="">Select a property...</option>';

    if (data.sites && data.sites.length > 0) {
      data.sites.forEach(site => {
        const option = document.createElement('option');
        option.value = site.url;
        option.textContent = site.url;
        selector.appendChild(option);
      });
    }
  } catch (err) {
    showGSCError('Failed to load sites: ' + err.message);
  }
}

async function loadGSCData() {
  const siteUrl = document.getElementById('gsc-site-selector').value;
  if (!siteUrl) return;

  showGSCLoading(true);
  hideGSCError();

  try {
    // Load queries, pages, and performance in parallel
    const [queriesRes, pagesRes, performanceRes] = await Promise.all([
      fetch(`/.netlify/functions/gsc?action=queries&siteUrl=${encodeURIComponent(siteUrl)}`, {
        headers: { 'Authorization': `Bearer ${getAuthToken()}` }
      }),
      fetch(`/.netlify/functions/gsc?action=pages&siteUrl=${encodeURIComponent(siteUrl)}`, {
        headers: { 'Authorization': `Bearer ${getAuthToken()}` }
      }),
      fetch(`/.netlify/functions/gsc?action=performance&siteUrl=${encodeURIComponent(siteUrl)}&dimensions=date`, {
        headers: { 'Authorization': `Bearer ${getAuthToken()}` }
      })
    ]);

    const [queriesData, pagesData, performanceData] = await Promise.all([
      queriesRes.json(),
      pagesRes.json(),
      performanceRes.json()
    ]);

    // Update totals from performance data
    if (performanceData.totals) {
      document.getElementById('gsc-total-clicks').textContent = formatNumber(performanceData.totals.clicks);
      document.getElementById('gsc-total-impressions').textContent = formatNumber(performanceData.totals.impressions);
      document.getElementById('gsc-avg-ctr').textContent = (performanceData.totals.avgCtr * 100).toFixed(2) + '%';
      document.getElementById('gsc-avg-position').textContent = performanceData.totals.avgPosition.toFixed(1);
    }

    // Update queries table
    updateGSCQueriesTable(queriesData.queries || []);

    // Update pages table
    updateGSCPagesTable(pagesData.pages || []);

    // Update chart
    updateGSCChart(performanceData.rows || []);

  } catch (err) {
    showGSCError('Failed to load data: ' + err.message);
  } finally {
    showGSCLoading(false);
  }
}

function refreshGSCData() {
  loadGSCData();
}

function updateGSCQueriesTable(queries) {
  const tbody = document.querySelector('#gsc-queries-table tbody');

  if (queries.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No query data available</td></tr>';
    return;
  }

  tbody.innerHTML = queries.map(q => `
    <tr>
      <td>${escapeHtml(q.query)}</td>
      <td class="text-end">${formatNumber(q.clicks)}</td>
      <td class="text-end">${formatNumber(q.impressions)}</td>
      <td class="text-end">${(q.ctr * 100).toFixed(2)}%</td>
      <td class="text-end">${q.position.toFixed(1)}</td>
    </tr>
  `).join('');
}

function updateGSCPagesTable(pages) {
  const tbody = document.querySelector('#gsc-pages-table tbody');

  if (pages.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No page data available</td></tr>';
    return;
  }

  tbody.innerHTML = pages.map(p => `
    <tr>
      <td><a href="${escapeHtml(p.page)}" target="_blank" class="text-decoration-none">${escapeHtml(p.page.replace(/^https?:\/\/[^\/]+/, ''))}</a></td>
      <td class="text-end">${formatNumber(p.clicks)}</td>
      <td class="text-end">${formatNumber(p.impressions)}</td>
      <td class="text-end">${(p.ctr * 100).toFixed(2)}%</td>
      <td class="text-end">${p.position.toFixed(1)}</td>
    </tr>
  `).join('');
}

function updateGSCChart(rows) {
  const canvas = document.getElementById('gsc-performance-chart');
  const ctx = canvas.getContext('2d');

  if (gscChart) {
    gscChart.destroy();
  }

  if (rows.length === 0) {
    return;
  }

  const labels = rows.map(r => r.date);
  const clicksData = rows.map(r => r.clicks);
  const impressionsData = rows.map(r => r.impressions);

  gscChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Clicks',
          data: clicksData,
          borderColor: 'rgb(54, 162, 235)',
          backgroundColor: 'rgba(54, 162, 235, 0.1)',
          fill: true,
          tension: 0.3,
          yAxisID: 'y'
        },
        {
          label: 'Impressions',
          data: impressionsData,
          borderColor: 'rgb(255, 159, 64)',
          backgroundColor: 'rgba(255, 159, 64, 0.1)',
          fill: true,
          tension: 0.3,
          yAxisID: 'y1'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false
      },
      scales: {
        y: {
          type: 'linear',
          display: true,
          position: 'left',
          title: { display: true, text: 'Clicks' }
        },
        y1: {
          type: 'linear',
          display: true,
          position: 'right',
          title: { display: true, text: 'Impressions' },
          grid: { drawOnChartArea: false }
        }
      },
      plugins: {
        legend: { position: 'top' }
      }
    }
  });
}

function showGSCLoading(show) {
  const loading = document.getElementById('gsc-loading');
  const notConnected = document.getElementById('gsc-not-connected');
  const connected = document.getElementById('gsc-connected');

  if (show) {
    loading.classList.remove('d-none');
    notConnected.classList.add('d-none');
    connected.classList.add('d-none');
  } else {
    loading.classList.add('d-none');
  }
}

function showGSCError(message) {
  const errorEl = document.getElementById('gsc-error');
  const messageEl = document.getElementById('gsc-error-message');
  messageEl.textContent = message;
  errorEl.classList.remove('d-none');
}

function hideGSCError() {
  document.getElementById('gsc-error').classList.add('d-none');
}

// Check for GSC callback params on page load
document.addEventListener('DOMContentLoaded', function() {
  const params = new URLSearchParams(window.location.search);

  if (params.get('gsc_connected') === 'true') {
    // Show success toast or notification
    showToast('Google Search Console connected successfully!', 'success');
    // Clean up URL
    window.history.replaceState({}, '', window.location.pathname);
    // Open the GSC modal
    setTimeout(() => openGSCModal(), 500);
  }

  if (params.get('gsc_error')) {
    showToast('Failed to connect Google Search Console: ' + params.get('gsc_error'), 'danger');
    window.history.replaceState({}, '', window.location.pathname);
  }
});

// === SIDEBAR FUNCTIONS ===
function toggleSidebar() {
  const sidebar = document.getElementById('dashboard-sidebar');
  const main = document.querySelector('.dashboard-main');
  const isExpanded = sidebar.classList.contains('expanded');

  if (isExpanded) {
    sidebar.classList.remove('expanded');
    main.classList.remove('sidebar-expanded');
    localStorage.setItem('zta_sidebar', 'collapsed');
  } else {
    sidebar.classList.add('expanded');
    main.classList.add('sidebar-expanded');
    localStorage.setItem('zta_sidebar', 'expanded');
  }
}

function openSidebar() {
  const sidebar = document.getElementById('dashboard-sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  sidebar.classList.add('mobile-open');
  overlay.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeSidebar() {
  const sidebar = document.getElementById('dashboard-sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  sidebar.classList.remove('mobile-open');
  overlay.classList.remove('active');
  document.body.style.overflow = '';
}

function scrollToStats() {
  const statsContent = document.getElementById('stats-content');
  if (statsContent) {
    statsContent.scrollIntoView({ behavior: 'smooth' });
  }
  closeSidebar();
}

function openExportDropdown() {
  // Create dropdown menu for export options
  const dropdown = document.createElement('div');
  dropdown.className = 'export-dropdown';
  dropdown.innerHTML = `
    <div class="export-dropdown-menu">
      <button onclick="exportData('json'); this.parentElement.parentElement.remove();">
        <i class="fas fa-file-code me-2"></i>Export JSON
      </button>
      <button onclick="exportData('csv'); this.parentElement.parentElement.remove();">
        <i class="fas fa-file-csv me-2"></i>Export CSV
      </button>
      <button onclick="exportPDF(); this.parentElement.parentElement.remove();">
        <i class="fas fa-file-pdf me-2"></i>Export PDF
      </button>
    </div>
  `;

  // Remove any existing dropdown
  const existing = document.querySelector('.export-dropdown');
  if (existing) existing.remove();

  // Position and show
  document.body.appendChild(dropdown);

  // Close on click outside
  setTimeout(() => {
    document.addEventListener('click', function closeDropdown(e) {
      if (!dropdown.contains(e.target)) {
        dropdown.remove();
        document.removeEventListener('click', closeDropdown);
      }
    });
  }, 10);

  closeSidebar();
}

// Initialize sidebar state
document.addEventListener('DOMContentLoaded', function() {
  const savedState = localStorage.getItem('zta_sidebar');
  const sidebar = document.getElementById('dashboard-sidebar');
  const main = document.querySelector('.dashboard-main');

  if (savedState === 'expanded' && window.innerWidth >= 992) {
    sidebar.classList.add('expanded');
    main.classList.add('sidebar-expanded');
  }

  // Close sidebar on mobile when clicking nav items
  const sidebarItems = document.querySelectorAll('.sidebar-item');
  sidebarItems.forEach(item => {
    item.addEventListener('click', function() {
      if (window.innerWidth < 992) {
        closeSidebar();
      }
    });
  });
});
</script>

<!-- Sidebar Styles -->
<style>
/* Dashboard Sidebar */
.dashboard-sidebar {
  position: fixed;
  left: 0;
  top: 0;
  bottom: 0;
  width: 60px;
  background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
  color: #e2e8f0;
  z-index: 1040;
  display: flex;
  flex-direction: column;
  transition: width 0.3s ease;
  overflow: hidden;
}

.dashboard-sidebar.expanded {
  width: 240px;
}

.sidebar-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem;
  border-bottom: 1px solid rgba(255,255,255,0.1);
  min-height: 60px;
}

.sidebar-brand {
  font-weight: 700;
  font-size: 1.25rem;
  color: #60a5fa;
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.dashboard-sidebar.expanded .sidebar-brand {
  opacity: 1;
}

.sidebar-toggle {
  background: transparent;
  border: none;
  color: #94a3b8;
  padding: 0.5rem;
  cursor: pointer;
  transition: color 0.2s ease;
}

.sidebar-toggle:hover {
  color: #fff;
}

.sidebar-nav {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 0.5rem 0;
}

.sidebar-section {
  padding: 0.5rem 0;
}

.sidebar-section-title {
  display: block;
  padding: 0.5rem 1rem;
  font-size: 0.65rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: #64748b;
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.dashboard-sidebar.expanded .sidebar-section-title {
  opacity: 1;
}

.sidebar-item {
  display: flex;
  align-items: center;
  width: 100%;
  padding: 0.75rem 1rem;
  background: transparent;
  border: none;
  color: #94a3b8;
  text-align: left;
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
}

.sidebar-item:hover {
  background: rgba(255,255,255,0.05);
  color: #fff;
}

.sidebar-item.active {
  background: rgba(96, 165, 250, 0.15);
  color: #60a5fa;
  border-left: 3px solid #60a5fa;
}

.sidebar-item i {
  width: 28px;
  text-align: center;
  font-size: 1rem;
  flex-shrink: 0;
}

.sidebar-item span {
  margin-left: 0.75rem;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.dashboard-sidebar.expanded .sidebar-item span {
  opacity: 1;
}

.sidebar-footer {
  border-top: 1px solid rgba(255,255,255,0.1);
  padding: 0.5rem 0;
}

/* Main Content Area */
.dashboard-main {
  margin-left: 60px;
  transition: margin-left 0.3s ease;
  min-height: 100vh;
}

.dashboard-main.sidebar-expanded {
  margin-left: 240px;
}

/* Mobile Styles */
.mobile-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.5rem 0;
}

.mobile-title {
  font-size: 1.25rem;
  font-weight: 600;
}

.sidebar-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 1035;
}

.sidebar-overlay.active {
  display: block;
}

/* Export Dropdown */
.export-dropdown {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 1050;
}

.export-dropdown-menu {
  background: var(--zta-card-bg, #fff);
  border: 1px solid var(--zta-border, #dee2e6);
  border-radius: 0.5rem;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  padding: 0.5rem;
  min-width: 200px;
}

.export-dropdown-menu button {
  display: block;
  width: 100%;
  padding: 0.75rem 1rem;
  background: transparent;
  border: none;
  text-align: left;
  color: var(--zta-text, #212529);
  border-radius: 0.25rem;
  cursor: pointer;
  transition: background 0.2s ease;
}

.export-dropdown-menu button:hover {
  background: var(--zta-bg-secondary, #f8f9fa);
}

@media (max-width: 991.98px) {
  .dashboard-sidebar {
    transform: translateX(-100%);
    width: 280px;
  }

  .dashboard-sidebar.mobile-open {
    transform: translateX(0);
  }

  .dashboard-sidebar.mobile-open .sidebar-brand,
  .dashboard-sidebar.mobile-open .sidebar-section-title,
  .dashboard-sidebar.mobile-open .sidebar-item span {
    opacity: 1;
  }

  .dashboard-main {
    margin-left: 0;
  }

  .dashboard-main.sidebar-expanded {
    margin-left: 0;
  }
}

/* Dark mode for sidebar */
[data-theme="dark"] .export-dropdown-menu {
  background: var(--zta-card-bg);
  border-color: var(--zta-border);
}

[data-theme="dark"] .export-dropdown-menu button {
  color: var(--zta-text);
}

[data-theme="dark"] .export-dropdown-menu button:hover {
  background: var(--zta-bg-tertiary);
}

/* Print: hide sidebar */
@media print {
  .dashboard-sidebar,
  .sidebar-overlay,
  .mobile-header {
    display: none !important;
  }

  .dashboard-main {
    margin-left: 0 !important;
  }
}
</style>

</div><!-- /container-fluid -->
</div><!-- /dashboard-container -->
</div><!-- /dashboard-main -->

{{ end }}
